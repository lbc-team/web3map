# ERC712

## 概念简介

ERC712（Ethereum Typed Structured Data Hashing and Signing）是一个以太坊改进提案，定义了结构化数据的类型化哈希和签名标准。该标准由以太坊创始人 [Vitalik](https://learnblockchain.cn/tags/Vitalik?map=EVM) Buterin 等人于2017年提出，旨在解决链下签名的安全性和可用性问题，为用户提供更安全、更可读的签名体验。

在 ERC712 出现之前,用户签署链下消息时看到的只是一串难以理解的十六进制数据,这使得恶意应用可以欺骗用户签署危险的交易。ERC712 通过引入结构化数据签名,让钱包能够以人类可读的格式展示签名内容,用户可以清楚地看到自己正在签署什么,大大提升了安全性。ERC712 已成为 DeFi、NFT、DAO 等 Web3 应用中链下签名的事实标准。

## 核心特性

### 结构化数据签名

ERC712 最重要的创新是引入了类型化的结构化数据签名：
- **类型定义**：明确定义数据结构的类型,如 `Person{string name, address wallet}`
- **嵌套支持**：支持复杂的嵌套数据结构
- **数组支持**：可以包含数组类型的字段
- **类型安全**：通过类型系统防止数据被篡改或误解

这使得签名数据具有明确的语义,钱包可以解析并展示给用户。

### 域分隔符（Domain Separator）

ERC712 引入了域分隔符的概念来防止重放攻击：
- **名称（name）**：DApp 或协议的名称
- **版本（version）**：协议版本号
- **链 ID（chainId）**：区块链网络标识,防止跨链重放
- **验证合约（verifyingContract）**：将使用此签名的合约地址
- **盐值（salt）**：可选的额外随机数

域分隔符确保签名只能在特定的上下文中有效,无法在其他 DApp、链或合约中被重用。

### 人类可读的签名界面

钱包可以将 ERC712 签名请求展示为结构化的表格形式：
```
MyDApp 请求签名:

域信息:
  名称: Uniswap V2
  版本: 1
  链 ID: 1 (以太坊主网)
  合约: 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D

消息内容:
  owner: 0x1234...5678
  spender: 0xabcd...ef00
  value: 1000000000000000000 (1 ETH)
  nonce: 5
  deadline: 1735689600
```

相比传统的十六进制哈希,这种展示方式让用户能够清楚理解签名内容。

### 防止签名冲突

ERC712 通过类型哈希机制防止不同数据结构之间的签名冲突：
- **类型哈希（typeHash）**：每个数据结构都有唯一的类型哈希
- **结构化哈希**：按照规范的顺序对数据进行哈希
- **确定性**：相同的数据总是产生相同的哈希

即使两个不同的数据结构恰好有相同的字段值,它们的 ERC712 签名也完全不同。

## 标准优势

**安全性提升**：ERC712 显著提升了链下签名的安全性。用户可以在签名前看到清晰的数据内容,防止被钓鱼网站欺骗。域分隔符机制有效防止了重放攻击和签名被滥用。

**标准化**：作为以太坊的标准提案,ERC712 被广泛采用,形成了统一的链下签名规范。开发者和用户都可以信赖这个标准。

**用户体验**：人类可读的签名界面大大改善了用户体验。用户不再需要盲目信任应用,而是可以验证签名内容的正确性。

**开发便利**：各种以太坊库（[ethers.js](https://learnblockchain.cn/tags/ethers.js?map=EVM)、web3.js、web3.py 等）都内置了 ERC712 支持,开发者可以轻松实现 ERC712 签名功能。

**Gas 效率**：链下签名不需要消耗 Gas,只有在将签名提交到链上验证时才需要。这使得许多操作可以在链下完成,降低成本。

**防止错误**：类型化的数据结构减少了开发者犯错的可能。编码和解码遵循明确的规则,不容易出现歧义。

## 工作原理

ERC712 签名过程分为以下步骤：

1. **定义域分隔符**
```solidity
bytes32 DOMAIN_SEPARATOR = keccak256(abi.encode(
    keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
    keccak256(bytes(name)),
    keccak256(bytes(version)),
    chainId,
    verifyingContract
));
```

2. **定义数据类型**
```solidity
bytes32 PERMIT_TYPEHASH = keccak256(
    "Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"
);
```

3. **构建结构化数据哈希**
```solidity
bytes32 structHash = keccak256(abi.encode(
    PERMIT_TYPEHASH,
    owner,
    spender,
    value,
    nonce,
    deadline
));
```

4. **生成最终签名哈希**
```solidity
bytes32 digest = keccak256(abi.encodePacked(
    "\x19\x01",
    DOMAIN_SEPARATOR,
    structHash
));
```

5. **对 digest 进行签名**,生成 v, r, s 签名参数。

## 应用场景

**[ERC20](https://learnblockchain.cn/tags/ERC20?map=EVM) Permit（ERC2612）**：允许用户通过签名授权代币转账,无需先调用 approve 函数,节省一笔交易的 Gas 费。

**去中心化交易所（[DEX](https://learnblockchain.cn/tags/DEX?map=EVM)）**：用户签署订单信息,链下撮合订单,只有成交时才上链,大大降低交易成本。如 [Uniswap](https://learnblockchain.cn/tags/Uniswap?map=EVM) V2/V3、0x Protocol。

**NFT 市场**：用户签署 NFT 出售订单,买家可以直接执行交易,无需卖家先上架 [NFT](https://learnblockchain.cn/tags/NFT)。如 [OpenSea](https://learnblockchain.cn/tags/OpenSea)、LooksRare 的链下订单系统。

**多签钱包**：Gnosis Safe 等多签钱包使用 ERC712 让签名者签署交易提案,收集足够签名后批量执行。

**DAO 治理**：链下投票系统（如 Snapshot）使用 ERC712 签名记录投票,最后将结果上链,节省 [Gas](https://learnblockchain.cn/tags/Gas?map=EVM) 并提高参与度。

**账户抽象（Account Abstraction）**：ERC4337 等账户抽象提案使用 ERC712 签名用户操作（UserOperation）。

**元交易（Meta-Transaction）**：用户签署交易意图,由中继器（Relayer）支付 [Gas](https://learnblockchain.cn/tags/Gas?map=EVM) 代为执行,实现 Gasless 体验。

**[DeFi](https://learnblockchain.cn/tags/DeFi?map=EVM) 协议**：借贷协议、流动性挖矿等场景使用 ERC712 简化用户交互,如 Aave、Compound 的 permit 功能。

## 发展历程

**2017年9月**：[Vitalik](https://learnblockchain.cn/tags/Vitalik?map=EVM) Buterin、Martin Swende 等人提出 EIP712 草案,旨在标准化结构化数据签名。

**2018年**：EIP712 规范逐步完善,社区展开讨论和测试。

**2019年**：主要[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)库开始实现 ERC712 支持。MetaMask 等钱包开始支持 ERC712 签名的可读展示。

**2020年**：ERC2612（[ERC20](https://learnblockchain.cn/tags/ERC20?map=EVM) Permit）标准提出,基于 ERC712 实现代币授权签名。[DeFi](https://learnblockchain.cn/tags/DeFi?map=EVM) 协议广泛采用。

**2021年**：[NFT](https://learnblockchain.cn/tags/NFT) 市场爆发,[OpenSea](https://learnblockchain.cn/tags/OpenSea) 等平台采用 ERC712 实现链下订单系统。Snapshot 等链下治理平台使用 ERC712 记录投票。

**2022年**：ERC712 成为 Web3 应用的标准签名方式,几乎所有主流 [DApp](https://learnblockchain.cn/tags/DApp) 都采用。[账户](https://learnblockchain.cn/tags/账户?map=EVM)抽象提案（ERC4337）将 ERC712 作为核心组件。

**2023年至今**：ERC712 持续演进,支持更复杂的数据类型和用例。已成为[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)生态不可或缺的基础标准。

## 安全考虑

**钱包兼容性**：并非所有钱包都完美支持 ERC712。开发者需要测试主流[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)的兼容性,提供降级方案。

**域分隔符验证**：合约必须严格验证域分隔符,确保签名来自正确的 [DApp](https://learnblockchain.cn/tags/DApp) 和链,防止跨链或跨合约重放攻击。

**nonce 管理**：使用 nonce 防止签名被重复使用。每个签名应该有唯一的 nonce,使用后失效。

**deadline 设置**：设置签名的有效期限,过期的签名应该被拒绝,防止旧签名在未来被滥用。

**钓鱼风险**：虽然 ERC712 提供了可读的签名界面,但用户仍需警惕。恶意网站可能伪装成合法应用,诱导用户签署危险内容。

**签名验证**：合约端必须正确实现签名验证逻辑,使用 `ecrecover` 恢复签名者地址并验证权限。

## 相关概念

- **ERC2612** - 基于 ERC712 的代币授权标准
- **ERC4337** - [账户](https://learnblockchain.cn/tags/账户?map=EVM)抽象标准，使用 ERC712 签名 UserOperation
- **MetaMask** - 支持 ERC712 签名展示的主流[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)
- **离线签名** - ERC712 是链下签名的标准实现方式
- **Snapshot** - 使用 ERC712 实现链下治理投票

## 相关链接

- EIP712 提案：https://learnblockchain.cn/docs/eips/EIPS/eip-712
- [ethers.js](https://learnblockchain.cn/tags/ethers.js?map=EVM) 文档：https://docs.ethers.org/v6/api/hashing/#typed-data
- [Viem](https://learnblockchain.cn/tags/Viem?map=EVM) EIP712 文档：https://viem.sh/docs/actions/wallet/signTypedData
- ERC2612 Permit：https://learnblockchain.cn/docs/eips/EIPS/eip-2612
- OpenZeppelin EIP712 实现：https://github.com/[OpenZeppelin](https://learnblockchain.cn/tags/OpenZeppelin?map=EVM)/openzeppelin-contracts/blob/master/contracts/utils/cryptography/EIP712.sol
- MetaMask 签名指南：https://docs.metamask.io/wallet/how-to/sign-data/
