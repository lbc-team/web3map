# EIP7702

## 概念简介

EIP7702（Set EOA account code）是由以太坊创始人 Vitalik Buterin 提出的以太坊改进提案,允许外部账户（EOA）在单笔交易执行期间临时委托代码执行。该提案是以太坊 Pectra 升级（Prague-Electra）的核心特性之一,预计在2024年底或2025年初激活。

EIP7702 的核心思想是让普通的以太坊账户（EOA）能够像智能合约账户一样执行复杂的逻辑,同时保持 EOA 的简单性和向后兼容性。用户可以临时将自己的 EOA"升级"为智能合约账户,享受批量交易、Gas 赞助、自定义验证逻辑等高级功能,交易结束后账户自动恢复为普通 EOA。这为账户抽象提供了一条更简单、更兼容的实现路径。

## 核心特性

### 临时代码委托

EIP7702 引入了新的交易类型,允许 EOA 在交易中临时设置代码：
- **授权列表（authorization list）**：交易包含一个或多个授权项,每项指定一个合约地址
- **临时代码**：交易执行期间,EOA 的代码被临时设置为指定合约的代码
- **自动恢复**：交易结束后,EOA 自动恢复为空代码,回到普通账户状态
- **签名保护**：授权必须由 EOA 的私钥签名,防止未经授权的代码注入

这种机制使得 EOA 可以"借用"智能合约的能力,而不需要永久转变为合约账户。

### 批量交易

通过委托代码,EOA 可以在一笔交易中执行多个操作：
- **批量转账**：一次交易向多个地址转账 ETH 或代币
- **批量授权**：同时授权多个 DApp 访问不同代币
- **复合操作**：在一笔交易中完成复杂的 DeFi 操作序列（如闪电贷套利）
- **原子性保证**：所有操作要么全部成功,要么全部失败,保证一致性

这大大提升了用户体验和交易效率,降低了 Gas 成本。

### Gas 赞助（Paymaster）

EIP7702 使得 Gas 赞助成为可能：
- **第三方付费**：DApp 或中继器可以代替用户支付 Gas 费
- **代币支付 Gas**：用户可以用 USDC、DAI 等稳定币支付 Gas,无需持有 ETH
- **免 Gas 体验**：新用户无需购买 ETH 即可开始使用 DApp
- **灵活的 Gas 策略**：项目方可以实施各种 Gas 补贴策略吸引用户

这解决了以太坊用户体验的一个长期痛点。

### 自定义验证逻辑

委托的合约可以实现自定义的交易验证逻辑：
- **多签验证**：EOA 可以临时启用多签功能,需要多个签名才能执行交易
- **社交恢复**：如果丢失私钥,可以通过预设的恢复机制找回账户
- **支出限制**：设置单笔交易或日/月支出上限,超过限制需要额外验证
- **时间锁**：重要操作需要延迟执行,给予反悔时间
- **会话密钥**：创建临时密钥用于特定操作,限制权限范围

这些功能使得 EOA 的安全性大大提升,接近甚至超过智能合约钱包。

### 向后兼容

EIP7702 的设计充分考虑了兼容性：
- **可选功能**：用户可以选择使用或不使用代码委托,不影响现有 EOA
- **标准交易**：不使用代码委托的交易与现有交易完全相同
- **钱包兼容**：旧版钱包仍可正常使用,只是无法享受新功能
- **渐进升级**：用户和应用可以按自己的节奏采用新特性

## 与其他提案的关系

**EIP7702 vs ERC4337**：
- ERC4337 是应用层的账户抽象方案,需要独立的 UserOperation 内存池和打包器
- EIP7702 是协议层的解决方案,直接扩展 EOA 功能,无需额外基础设施
- 两者可以共存,EIP7702 提供了更简单的入门路径

**EIP7702 vs EIP3074**：
- EIP3074 提案引入 AUTH 和 AUTHCALL 操作码,也允许 EOA 委托代码执行
- EIP7702 被视为 EIP3074 的改进版本,解决了一些安全和设计问题
- EIP7702 最终取代了 EIP3074,成为 Pectra 升级的一部分

**EIP7702 vs 智能合约钱包**：
- 智能合约钱包是独立的合约账户,需要部署和管理
- EIP7702 增强现有 EOA,无需部署新账户,保持地址不变
- EIP7702 更轻量,但智能合约钱包功能更丰富和持久

## 应用场景

**新用户入门**：项目方可以赞助新用户的 Gas 费,用户无需先购买 ETH 即可开始使用 DApp,降低进入门槛。

**批量操作**：用户在一笔交易中完成多个操作,如在 DeFi 中进行复杂的策略执行（存款、兑换、质押等），节省 Gas 和时间。

**社交恢复钱包**：用户可以设置信任的朋友或设备作为恢复机制,丢失私钥时通过社交恢复找回账户。

**企业账户管理**：企业可以为员工 EOA 设置多签验证、支出限制等策略,加强内部财务控制。

**游戏和应用**：链游可以使用会话密钥让玩家在游戏中自由操作,而不需要每次都确认签名,提升体验的同时保持安全。

**DeFi 策略自动化**：用户可以授权智能合约代理执行预设的 DeFi 策略,如自动再平衡、止损等,而无需信任中心化服务。

**合规和监管**：企业可以在 EOA 上实施合规检查,确保所有交易符合监管要求,如 AML/KYC 验证。

**跨链桥接**：简化跨链操作,在一笔交易中完成多链资产转移和桥接。

## 安全考虑

**代码审计**：委托的合约代码必须经过严格审计。恶意或有漏洞的合约代码可能导致资金损失。

**授权验证**：钱包必须清楚地向用户展示授权的合约地址和功能,防止用户被欺骗授权恶意合约。

**nonce 管理**：授权签名应包含 nonce,防止重放攻击。确保每个授权只能使用一次。

**链 ID 验证**：授权必须包含链 ID,防止跨链重放攻击。签名在其他链上无效。

**权限范围**：委托的合约应该有明确的权限范围限制,避免过度授权。用户应该能够撤销授权。

**钓鱼风险**：恶意网站可能诱导用户授权危险的合约。用户需要谨慎验证 DApp 的真实性。

**临时性限制**：虽然代码委托是临时的,但在交易执行期间,合约拥有 EOA 的全部权限,需要特别小心。

## 发展历程

**2023年5月**：Vitalik Buterin 提出 EIP7702 草案,作为对 EIP3074 的改进。

**2023年下半年**：EIP7702 在以太坊核心开发者会议中讨论,逐步完善设计细节。

**2024年初**：EIP7702 被纳入 Pectra 升级（Prague-Electra）的候选 EIP 列表。

**2024年中**：各以太坊客户端开始实现 EIP7702,在测试网进行测试。

**2024年下半年**：Pectra 升级在测试网上线,EIP7702 功能接受社区测试和审查。

**预计2025年**：Pectra 升级在以太坊主网激活,EIP7702 正式生效,用户和应用开始采用。

## 相关概念

- **ERC4337** - 应用层的账户抽象标准，与 EIP7702 互补
- **EIP3074** - 被 EIP7702 取代的 EOA 授权提案
- **账户抽象** - EIP7702 是实现账户抽象的协议层方案
- **智能合约钱包** - Gnosis Safe、Argent 等合约钱包
- **Pectra 升级** - EIP7702 所属的以太坊升级
- **Paymaster** - 代付 Gas 的第三方服务
- **社交恢复** - 基于 EIP7702 可实现的账户恢复机制

## 相关链接

- EIP7702 提案：https://eips.ethereum.org/EIPS/eip-7702
- Vitalik 的解释文章：https://ethereum-magicians.org/t/eip-7702-set-eoa-account-code/19923
- Pectra 升级信息：https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/prague.md
- 以太坊路线图：https://ethereum.org/en/roadmap/
- EIP3074（被 EIP7702 取代）：https://eips.ethereum.org/EIPS/eip-3074
- ERC4337 账户抽象：https://eips.ethereum.org/EIPS/eip-4337
