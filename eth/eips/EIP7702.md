# EIP-7702: 设置 EOA 账户代码

## 概念简介

EIP-7702（Set EOA account code）是由 Vitalik Buterin 等人提出的以太坊改进提案，允许外部账户（EOA）在交易执行期间**设置自己的合约代码**。 之后 EOA 账户就可以作为智能合约账户使用。

该提案被视为以太坊 Pectra 升级（Prague-Electra 2025年初完成升级）的核心特性之一，旨在为 EOA 赋予智能合约功能，提供了一条兼容性极强且灵活的账户抽象路径。

## 核心特性


EIP-7702 核心机制是：
- **设置代码**：交易包含一个授权列表，用户签名授权后，EOA 的代码会被设置为一个特殊的“委托指针”（Delegation Designator，格式为 `0xef0100...` + 合约地址）。
- **持久生效**：一旦设置，EOA 在后续的每笔交易中都会表现得像该智能合约一样，直到用户再次发送指令修改它。这意味着用户可以“升级”自己的钱包，获得多签、社交恢复等长期功能。
- **可撤销性**：用户随时可以通过签署一个新的授权指令，将代码重置为空（或指向零地址），从而把账户“降级”回普通的 EOA。
- **跨交易状态**：由于代码是持久的，EOA 可以拥有更稳定的合约状态和逻辑，而不仅仅是临时的脚本执行。

### 批量交易与自动化

通过持久化或临时的代码委托，EOA 可以实现：
- **批量操作**：原子性地执行一系列交易（如 Approve + Swap）。
- **自动化**：授权合约根据预设条件自动执行操作。

### Gas 赞助（Paymaster）

支持第三方代付 Gas：
- **代币支付**：用户可以使用 USDC 等代币支付 Gas，由 Relayer 转换。
- **应用补贴**：项目方可以为用户补贴 Gas 费用，降低门槛。

### 安全增强

- **权限控制**：通过委托给特定的智能合约，EOA 可以限制特定 DApp 的扣款额度。
- **社交恢复**：如果私钥丢失，可以通过预设的守护者（Guardians）重置账户的控制权（即修改委托的代码）。
- **量子抗性准备**：未来可以通过升级委托的合约代码来支持抗量子签名算法，而无需迁移资产。

## 机制原理

EIP-7702 引入了一种新的交易类型（Transaction Type 4），其中包含一个 `authorization_list`。
- 每个授权项包含：`[chain_id, address, nonce, y_parity, r, s]`。
- 这里的 `address` 是用户希望 EOA 委托的目标合约地址。
- 当交易被打包时，如果签名验证通过，EOA 的 `code` 字段会被更新为指向该地址的特殊字节码。
- 在 EVM 执行过程中，任何涉及加载该 EOA 代码的操作，都会自动加载并执行目标合约的代码。

## 与其他提案的关系

**EIP-7702 vs EIP-3074**：
- **持久性**：EIP-3074 是基于 `AUTH/AUTHCALL` 操作码的，其授权仅在单笔交易内有效（或通过较复杂的机制维持），主要侧重于“调用者”的临时权限。EIP-7702 则直接修改账户状态，支持持久化升级。
- **未来兼容性**：EIP-7702 的设计更接近最终的账户抽象目标，被认为是以太坊账户体系演进的更优解，因此取代了 EIP-3074 进入 Pectra 升级。

**EIP-7702 vs ERC-4337**：
- **基础设施**：ERC-4337 需要独立的 UserOps 内存池和 Bundler 网络。EIP-7702 直接使用现有的以太坊交易内存池。
- **互操作性**：EIP-7702 可以被设计为与 ERC-4337 兼容。例如，EOA 可以委托给一个实现了 ERC-4337 接口的合约，从而让 EOA 也能被 Bundler 识别和操作。

## 应用场景

1.  **钱包升级**：现有的 MetaMask 用户可以一键将账户升级为多签钱包或支持社交恢复的钱包，且地址不变。
2.  **长期授权**：用户可以授权一个自动投资合约，长期管理其资金，而无需每次操作都签名。
3.  **无感交互**：通过会话密钥（Session Keys）和持久化代码，实现链游的高频无感交互。

## 安全考虑

- **恶意合约风险**：如果用户被诱导签署了指向恶意合约的授权，该合约可以完全控制用户的 EOA，包括转走所有资产。因此，钱包端必须对授权的目标地址进行严格的白名单或风险提示。
- **撤销机制**：必须确保用户始终保留将代码重置的最高权限，防止被恶意合约“锁死”。


## 相关链接

- [EIP-7702 Standard](https://eips.ethereum.org/EIPS/eip-7702)
- [Vitalik Buterin: EIP-7702](https://ethereum-magicians.org/t/eip-7702-set-eoa-account-code/19923)