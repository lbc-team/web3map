## EIP-6963

### 概念简介

EIP-6963（Multi Injected Provider Discovery）是以太坊的多钱包发现标准，于 2023 年 10 月被正式接受。这个标准解决了浏览器中多个钱包扩展共存时的发现和选择问题，使用基于事件的机制让 DApp 能够发现并连接到所有已安装的钱包。

在 EIP-6963 之前，多个钱包通过争夺 `window.ethereum` 导致用户体验混乱。EIP-6963 通过事件驱动的双向通信彻底解决了这个问题。

### 背景问题

**Window.ethereum 的竞争条件**
传统方式中，钱包扩展都注入到 `window.ethereum`：
```javascript
// MetaMask 注入
window.ethereum = metamaskProvider

// Trust Wallet 后加载，覆盖了 MetaMask
window.ethereum = trustWalletProvider

// 用户无法选择，只能使用最后加载的钱包
```

**存在的问题**：
1. **加载顺序不确定**：浏览器扩展的加载顺序是随机的
2. **后者覆盖前者**：最后加载的钱包"获胜"
3. **用户无法选择**：无法在页面上选择使用哪个钱包
4. **开发者困境**：无法知道用户安装了哪些钱包
5. **体验不一致**：每次刷新可能连接不同的钱包

### EIP-6963 的解决方案

**事件驱动的发现机制**
不再使用共享的可变对象，而是通过 window 事件进行双向通信：

1. **DApp 请求发现**：触发 `eip6963:requestProvider` 事件
2. **钱包响应**：每个钱包触发 `eip6963:announceProvider` 事件
3. **DApp 展示列表**：收集所有钱包并让用户选择
4. **用户选择**：用户明确选择要使用的钱包

### 核心接口

**EIP6963ProviderInfo**
钱包提供的信息结构：
```typescript
interface EIP6963ProviderInfo {
    uuid: string;        // 钱包实例的唯一标识符
    name: string;        // 钱包名称，如 "MetaMask"
    icon: string;        // 钱包图标（Data URI）
    rdns: string;        // 反向 DNS 名称，如 "io.metamask"
}
```

**EIP6963ProviderDetail**
包含完整的提供者信息：
```typescript
interface EIP6963ProviderDetail {
    info: EIP6963ProviderInfo;
    provider: EIP1193Provider;  // 实际的提供者对象
}
```

**EIP6963AnnounceProviderEvent**
钱包公告事件：
```typescript
interface EIP6963AnnounceProviderEvent extends CustomEvent {
    type: "eip6963:announceProvider";
    detail: EIP6963ProviderDetail;
}
```

**EIP6963RequestProviderEvent**
DApp 请求事件：
```typescript
interface EIP6963RequestProviderEvent extends Event {
    type: "eip6963:requestProvider";
}
```

### 实现示例

**钱包扩展实现**
```javascript
// 钱包扩展的代码
function announceProvider() {
    const info = {
        uuid: "350670db-19fa-4704-a166-e52e178b59d2",
        name: "Example Wallet",
        icon: "data:image/svg+xml,...",  // Base64 编码的 SVG
        rdns: "com.example.wallet"
    };

    const detail = {
        info,
        provider: window.myWalletProvider  // EIP-1193 提供者
    };

    // 触发公告事件
    window.dispatchEvent(
        new CustomEvent("eip6963:announceProvider", {
            detail: Object.freeze(detail)
        })
    );
}

// 监听 DApp 的请求
window.addEventListener("eip6963:requestProvider", () => {
    announceProvider();
});

// 页面加载时主动公告
announceProvider();
```

**DApp 集成实现**
```javascript
// DApp 的代码
const providers = new Map();

// 监听钱包公告
window.addEventListener("eip6963:announceProvider", (event) => {
    const { info, provider } = event.detail;

    // 存储发现的提供者
    providers.set(info.uuid, { info, provider });

    // 更新 UI，显示可用钱包列表
    renderWalletList(Array.from(providers.values()));
});

// 请求钱包公告
function discoverWallets() {
    window.dispatchEvent(new Event("eip6963:requestProvider"));
}

// 页面加载时发现钱包
window.addEventListener("load", () => {
    discoverWallets();
});
```

**完整的钱包选择器组件**
```javascript
class WalletSelector {
    constructor() {
        this.providers = new Map();
        this.selectedProvider = null;

        this.listenForProviders();
        this.requestProviders();
    }

    listenForProviders() {
        window.addEventListener(
            "eip6963:announceProvider",
            (event) => {
                const { info, provider } = event.detail;
                this.providers.set(info.uuid, { info, provider });
                this.render();
            }
        );
    }

    requestProviders() {
        window.dispatchEvent(new Event("eip6963:requestProvider"));
    }

    async connect(uuid) {
        const providerDetail = this.providers.get(uuid);
        if (!providerDetail) return;

        const { provider } = providerDetail;

        try {
            // 使用 EIP-1193 请求连接
            const accounts = await provider.request({
                method: "eth_requestAccounts"
            });

            this.selectedProvider = providerDetail;
            console.log("Connected:", accounts[0]);
            return accounts[0];
        } catch (error) {
            console.error("Connection failed:", error);
        }
    }

    render() {
        const container = document.getElementById("wallets");
        container.innerHTML = "";

        this.providers.forEach(({ info, provider }, uuid) => {
            const button = document.createElement("button");

            // 显示钱包图标
            const icon = document.createElement("img");
            icon.src = info.icon;
            icon.width = 32;
            icon.height = 32;
            button.appendChild(icon);

            // 显示钱包名称
            const name = document.createElement("span");
            name.textContent = info.name;
            button.appendChild(name);

            // 点击连接
            button.onclick = () => this.connect(uuid);

            container.appendChild(button);
        });
    }
}

// 使用
const walletSelector = new WalletSelector();
```

### React Hook 示例

```typescript
import { useEffect, useState } from 'react';

interface Wallet {
    uuid: string;
    name: string;
    icon: string;
    provider: any;
}

export function useWalletDiscovery() {
    const [wallets, setWallets] = useState<Wallet[]>([]);

    useEffect(() => {
        const handleAnnouncement = (event: any) => {
            const { info, provider } = event.detail;

            setWallets(prev => {
                // 避免重复
                if (prev.some(w => w.uuid === info.uuid)) {
                    return prev;
                }

                return [...prev, {
                    uuid: info.uuid,
                    name: info.name,
                    icon: info.icon,
                    provider
                }];
            });
        };

        window.addEventListener(
            'eip6963:announceProvider',
            handleAnnouncement
        );

        // 请求钱包公告
        window.dispatchEvent(new Event('eip6963:requestProvider'));

        return () => {
            window.removeEventListener(
                'eip6963:announceProvider',
                handleAnnouncement
            );
        };
    }, []);

    const connectWallet = async (uuid: string) => {
        const wallet = wallets.find(w => w.uuid === uuid);
        if (!wallet) return;

        try {
            const accounts = await wallet.provider.request({
                method: 'eth_requestAccounts'
            });
            return accounts[0];
        } catch (error) {
            console.error('Failed to connect:', error);
        }
    };

    return { wallets, connectWallet };
}

// 在组件中使用
function WalletConnector() {
    const { wallets, connectWallet } = useWalletDiscovery();

    return (
        <div>
            <h2>选择钱包</h2>
            {wallets.map(wallet => (
                <button
                    key={wallet.uuid}
                    onClick={() => connectWallet(wallet.uuid)}
                >
                    <img src={wallet.icon} alt={wallet.name} width={32} />
                    <span>{wallet.name}</span>
                </button>
            ))}
        </div>
    );
}
```

### 关键优势

**消除竞争条件**
- 不再依赖 `window.ethereum`
- 避免钱包之间的覆盖
- 加载顺序无关紧要

**用户控制**
- 用户清楚看到所有已安装的钱包
- 明确选择要使用的钱包
- 可以随时切换钱包

**开发者友好**
- 自动发现所有兼容钱包
- 统一的连接流程
- 不需要钱包特定的代码

**更好的用户体验**
- 一致的钱包选择界面
- 清晰的钱包品牌展示
- 避免混淆和错误

### 与现有标准的关系

**与 EIP-1193 配合**
EIP-6963 发现钱包，EIP-1193 定义交互：
```javascript
// EIP-6963：发现钱包
window.dispatchEvent(new Event("eip6963:requestProvider"));

// 获取提供者后，使用 EIP-1193 交互
const accounts = await provider.request({
    method: "eth_requestAccounts"
});
```

**向后兼容**
钱包仍然可以注入 `window.ethereum`：
- 支持旧版 DApp
- 新 DApp 使用 EIP-6963
- 平滑过渡

### 钱包采用情况

**已支持的钱包**
- MetaMask
- Coinbase Wallet
- Trust Wallet
- Rainbow
- Zerion
- Rabby
- Phantom（计划中）

**实施指南**
钱包开发者需要：
1. 实现 EIP-6963 事件机制
2. 提供钱包元数据（名称、图标、rdns）
3. 保持 EIP-1193 兼容性
4. 测试与其他钱包的共存

### 最佳实践

**RDNS 命名**
使用反向域名：
```
com.example.wallet
io.metamask
com.coinbase.wallet
```

**UUID 生成**
为每个钱包实例生成唯一 UUID：
```javascript
import { v4 as uuidv4 } from 'uuid';

const uuid = uuidv4(); // 每个实例不同
```

**图标格式**
使用 Data URI 格式的 SVG：
```javascript
const icon = "data:image/svg+xml;base64," + btoa(svgString);
```

**防御性编程**
```javascript
// 检查事件支持
if (typeof window !== 'undefined' && window.dispatchEvent) {
    window.dispatchEvent(new Event("eip6963:requestProvider"));
}

// 处理重复公告
const seen = new Set();
window.addEventListener("eip6963:announceProvider", (event) => {
    const { uuid } = event.detail.info;
    if (seen.has(uuid)) return;
    seen.add(uuid);
    // 处理新钱包
});
```

### 迁移指南

**从旧方式迁移**
```javascript
// 旧方式
if (window.ethereum) {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
}

// 新方式
const walletSelector = new WalletSelector();
// 让用户选择钱包
```

**同时支持两种方式**
```javascript
// 优先使用 EIP-6963
const providers = await discoverProviders();

if (providers.length > 0) {
    // 使用 EIP-6963 发现的钱包
    await connectWithProvider(providers[0]);
} else if (window.ethereum) {
    // 回退到传统方式
    await window.ethereum.request({ method: 'eth_requestAccounts' });
} else {
    // 提示用户安装钱包
    alert('Please install a wallet');
}
```

### 工具和库

**@metamask/detect-provider**
```javascript
import detectProvider from '@metamask/detect-provider';

const provider = await detectProvider({
    // 自动使用 EIP-6963
    mustBeMetaMask: true,
    silent: false
});
```

**RainbowKit**
已集成 EIP-6963 支持：
```javascript
import { connectorsForWallets } from '@rainbow-me/rainbowkit';

const connectors = connectorsForWallets([
    // 自动发现所有 EIP-6963 钱包
]);
```

**Web3Modal**
最新版本支持 EIP-6963：
```javascript
import { Web3Modal } from '@web3modal/ethereum';

const modal = new Web3Modal({
    // 自动发现所有钱包
});
```

### 未来展望

**生态系统采用**
EIP-6963 正在快速成为标准：
- 主流钱包陆续支持
- 新钱包默认实现
- DApp 框架集成

**改进方向**
- 钱包能力协商（支持的链、功能）
- 更丰富的元数据
- 移动端适配

**与 EIP-5792 的结合**
EIP-5792 定义了钱包能力：
- 发现钱包（EIP-6963）
- 查询钱包能力（EIP-5792）
- 完整的钱包生态系统

### 相关链接

- [EIP-6963 官方规范](https://eips.ethereum.org/EIPS/eip-6963)
- [EIP-6963 官方网站](https://eip6963.org/)
- [MetaMask EIP-6963 实现指南](https://docs.metamask.io/wallet/how-to/use-eip-6963/)
- [WalletConnect EIP-6963 示例](https://github.com/WalletConnect/EIP6963)
