## EIP-1193

### 概念简介

EIP-1193（Ethereum Provider JavaScript API）是以太坊提供者的标准 [JavaScript](https://learnblockchain.cn/tags/JavaScript) API 规范，定义了浏览器钱包（如 MetaMask）与 Web3 应用（DApp）之间的通信接口。这个标准统一了不同钱包的 API 行为，使开发者能够编写兼容所有符合标准的钱包的 DApp。

在 EIP-1193 之前，不同钱包的 API 实现各不相同，导致开发者需要为每个钱包编写不同的适配代码。EIP-1193 的出现极大地改善了这一情况。

### 背景

**钱包碎片化问题**
早期的以太坊生态中：
- MetaMask、Trust Wallet、Coinbase Wallet 等钱包各自为政
- 每个钱包都有略微不同的 API
- 事件触发机制不一致
- 开发者需要编写大量兼容性代码

**Window.ethereum 的混乱**
历史上，钱包通过 `window.ethereum` 注入提供者对象：
- 多个钱包同时注入时会产生冲突
- 后加载的钱包会覆盖前面的
- 用户无法选择使用哪个钱包
- 导致不可预测的行为

### 核心概念

**提供者（Provider）**
提供者是一个 [JavaScript](https://learnblockchain.cn/tags/JavaScript) 对象，提供对[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)的访问：
- 暴露标准的 API 方法
- 发出标准化的事件
- 处理 RPC 请求

**事件驱动架构**
EIP-1193 采用事件驱动设计：
- 钱包状态变化时发出事件
- DApp 监听事件并作出响应
- 避免轮询，提高效率

**传输无关性**
该标准与底层传输协议无关：
- 可以通过 HTTP、WebSocket 等协议通信
- 可以与不同的[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)客户端交互
- 灵活的架构设计

### 核心接口

**请求方法**
```javascript
// 核心方法：发送 JSON-RPC 请求
provider.request({
  method: string,
  params?: Array<any>
}): Promise<any>

// 示例：请求账户访问权限
await provider.request({
  method: 'eth_requestAccounts'
})

// 示例：发送交易
await provider.request({
  method: 'eth_sendTransaction',
  params: [{
    from: '0x...',
    to: '0x...',
    value: '0x...',
    // ...
  }]
})

// 示例：获取余额
const balance = await provider.request({
  method: 'eth_getBalance',
  params: ['0x...', 'latest']
})
```

**事件监听**
```javascript
// 监听账户变化
provider.on('accountsChanged', (accounts) => {
  console.log('当前账户:', accounts[0])
  // 更新 UI
})

// 监听链切换
provider.on('chainChanged', (chainId) => {
  console.log('切换到链:', chainId)
  // 重新加载页面或更新状态
  window.location.reload()
})

// 监听连接状态
provider.on('connect', (connectInfo) => {
  console.log('已连接到链:', connectInfo.chainId)
})

// 监听断开连接
provider.on('disconnect', (error) => {
  console.log('已断开连接:', error)
  // 显示重连 UI
})

// 监听消息（可选）
provider.on('message', (message) => {
  console.log('收到消息:', message)
})
```

**移除监听器**
```javascript
// 遵循 Node.js EventEmitter API
provider.removeListener('accountsChanged', handler)
provider.off('chainChanged', handler)
```

### 标准事件

**accountsChanged**
当用户切换[账户](https://learnblockchain.cn/tags/账户?map=EVM)或授权状态变化时触发：
```javascript
provider.on('accountsChanged', (accounts: string[]) => {
  if (accounts.length === 0) {
    // 用户断开了所有账户
    console.log('请连接 MetaMask')
  } else {
    // 用户切换了账户
    const currentAccount = accounts[0]
  }
})
```

**chainChanged**
当用户切换网络时触发：
```javascript
provider.on('chainChanged', (chainId: string) => {
  // chainId 是十六进制字符串，如 '0x1' (主网)
  // 建议重新加载页面以避免状态不一致
  window.location.reload()
})
```

**connect**
当提供者连接到链时触发：
```javascript
provider.on('connect', (connectInfo: { chainId: string }) => {
  console.log('已连接到链 ID:', connectInfo.chainId)
})
```

**disconnect**
当提供者断开连接时触发：
```javascript
provider.on('disconnect', (error: ProviderRpcError) => {
  console.error('断开连接:', error.message, error.code)
})
```

### 错误处理

**标准错误码**
EIP-1193 定义了标准的 JSON-RPC 错误码：

```javascript
try {
  await provider.request({ method: 'eth_sendTransaction', params: [...] })
} catch (error) {
  if (error.code === 4001) {
    // 用户拒绝了请求
    console.log('用户取消了交易')
  } else if (error.code === -32002) {
    // 请求已经在处理中
    console.log('请在钱包中确认')
  } else if (error.code === -32603) {
    // 内部错误
    console.error('交易失败:', error.message)
  }
}
```

**常见错误码**
- `4001`：用户拒绝请求
- `4100`：请求的方法或参数不被支持
- `4200`：提供者未授权执行该操作
- `4900`：提供者断开连接
- `-32700`：解析错误
- `-32600`：无效请求
- `-32601`：方法不存在
- `-32602`：无效参数
- `-32603`：内部错误

### 实际应用示例

**连接钱包**
```javascript
async function connectWallet() {
  if (typeof window.ethereum !== 'undefined') {
    try {
      // 请求账户访问权限
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      })

      const account = accounts[0]
      console.log('已连接账户:', account)

      // 获取链 ID
      const chainId = await window.ethereum.request({
        method: 'eth_chainId'
      })
      console.log('当前链 ID:', chainId)

      return account
    } catch (error) {
      if (error.code === 4001) {
        console.log('用户拒绝了连接')
      } else {
        console.error('连接失败:', error)
      }
    }
  } else {
    console.log('请安装 MetaMask')
  }
}
```

**发送交易**
```javascript
async function sendTransaction(to, value) {
  try {
    const transactionHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{
        from: currentAccount,
        to: to,
        value: value, // 十六进制 wei
        gas: '0x5208', // 21000
      }]
    })

    console.log('交易哈希:', transactionHash)
    return transactionHash
  } catch (error) {
    console.error('交易失败:', error)
  }
}
```

**签名消息**
```javascript
async function signMessage(message) {
  try {
    const signature = await window.ethereum.request({
      method: 'personal_sign',
      params: [message, currentAccount]
    })

    console.log('签名:', signature)
    return signature
  } catch (error) {
    console.error('签名失败:', error)
  }
}
```

**切换网络**
```javascript
async function switchToPolygon() {
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: '0x89' }], // Polygon 主网
    })
  } catch (error) {
    if (error.code === 4902) {
      // 链未添加，需要先添加
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: '0x89',
          chainName: 'Polygon',
          nativeCurrency: {
            name: 'MATIC',
            symbol: 'MATIC',
            decimals: 18
          },
          rpcUrls: ['https://polygon-rpc.com'],
          blockExplorerUrls: ['https://polygonscan.com']
        }]
      })
    }
  }
}
```

### 与 Web3 库的关系

**Ethers.js**
```javascript
import { ethers } from 'ethers'

// 使用 EIP-1193 提供者
const provider = new ethers.BrowserProvider(window.ethereum)
const signer = await provider.getSigner()
```

**Web3.js**
```javascript
import Web3 from 'web3'

// 使用 EIP-1193 提供者
const web3 = new Web3(window.ethereum)
```

**Wagmi（React）**
```javascript
import { WagmiConfig, createConfig } from 'wagmi'
import { mainnet } from 'wagmi/chains'
import { InjectedConnector } from 'wagmi/connectors/injected'

// 自动使用 EIP-1193 提供者
const config = createConfig({
  chains: [mainnet],
  connectors: [new InjectedConnector()],
})
```

### 最佳实践

**初始化检查**
```javascript
// 检查提供者是否可用
if (typeof window.ethereum !== 'undefined') {
  console.log('检测到以太坊提供者')

  // 检查是否是 MetaMask
  if (window.ethereum.isMetaMask) {
    console.log('这是 MetaMask')
  }
} else {
  console.log('请安装 MetaMask 或其他钱包')
}
```

**处理链切换**
```javascript
// 监听链切换并重新加载
window.ethereum.on('chainChanged', (chainId) => {
  // 强烈建议重新加载页面
  window.location.reload()
})
```

**处理[账户](https://learnblockchain.cn/tags/账户?map=EVM)变化**
```javascript
// 监听账户切换
window.ethereum.on('accountsChanged', (accounts) => {
  if (accounts.length === 0) {
    // 用户断开了连接
    setCurrentAccount(null)
  } else {
    // 用户切换了账户
    setCurrentAccount(accounts[0])
  }
})
```

**错误处理**
```javascript
// 始终处理错误
try {
  const result = await window.ethereum.request({ ... })
} catch (error) {
  // 用户可读的错误消息
  if (error.code === 4001) {
    showMessage('您取消了操作')
  } else {
    showMessage(`操作失败: ${error.message}`)
  }
}
```

### EIP-6963 的补充

EIP-1193 定义了提供者 API，但多钱包共存仍有问题。EIP-6963（Multi Injected Provider Discovery）解决了这个问题：
- 使用事件机制发现多个钱包
- 用户可以选择使用哪个钱包
- 避免 `window.ethereum` 的竞争条件

### 生态系统影响

**钱包开发者**
- 必须实现 EIP-1193 才能兼容主流 [DApp](https://learnblockchain.cn/tags/DApp)
- 提供一致的用户体验
- 降低开发和维护成本

**[DApp](https://learnblockchain.cn/tags/DApp) 开发者**
- 编写一次代码，兼容所有钱包
- 不再需要[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)特定的适配器
- 更可靠的 API 行为

**用户**
- 可以自由选择[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)
- 一致的交互体验
- 更少的兼容性问题

### 相关链接

- [EIP-1193 官方规范](https://learnblockchain.cn/docs/eips/EIPS/eip-1193)
- [MetaMask 文档](https://docs.metamask.io/wallet/reference/provider-api/)
- [Ethers.js 提供者文档](https://docs.ethers.org/v6/api/providers/)
- [EIP-6963 多钱包发现](https://learnblockchain.cn/docs/eips/EIPS/eip-6963)
