## EIP-7623

### 概念简介

EIP-7623（Increase Calldata Cost）是以太坊 Pectra 升级的一部分，提议增加数据密集型交易的 calldata 成本，以减少可能的最大区块大小并控制区块大小的方差。该提案已于 2025 年 5 月在以太坊主网激活。

这个提案的核心目标是限制 rollup 等数据密集型应用对[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)区块空间的使用，同时不影响普通用户的交易成本。

### 背景和动机

**区块大小问题**
在当前的 calldata 定价下：
- 每字节 calldata 成本：4 gas（零字节）/ 16 gas（非零字节）
- 区块 Gas 限制：30,000,000 gas
- 理论最大区块大小：约 7.15 MB
- 实际平均区块大小：约 100 KB

**巨大的差距**
- 最大可能：7.15 MB
- 实际使用：100 KB
- 差距：70 倍以上

这种巨大的差距导致：
1. **区块大小方差大**：峰值时区块巨大，影响网络稳定性
2. **资源浪费**：节点必须为极端情况准备资源
3. **潜在的 DOS 攻击**：恶意者可以构造巨大的区块

**Rollup 的数据需求**
自从 EIP-4844 引入 blob 后，部分 rollup 仍然使用 calldata：
- 某些 rollup 尚未迁移到 blob
- Calldata 提供更快的数据可用性
- 但占用了主要的区块空间

### EIP-7623 的解决方案

**差异化定价**
对数据密集型交易提高 calldata 成本：
- **数据密集型交易**：calldata 成本提高到 10/40 gas/字节
- **计算密集型交易**：保持原来的 4/16 gas/字节

**判断标准**
如何区分两类交易：
```
如果交易的 EVM 计算 Gas < calldata Gas 的一定比例
→ 视为数据密集型交易
→ 使用更高的 calldata 定价
```

### 定价机制

**旧定价（EIP-7623 之前）**
```
零字节：4 gas/byte
非零字节：16 gas/byte

最大 calldata：30,000,000 / 4 ≈ 7.15 MB
```

**新定价（数据密集型交易）**
```
零字节：10 gas/byte
非零字节：40 gas/byte

最大 calldata：30,000,000 / 40 = 0.75 MB
```

**计算密集型交易保持不变**
如果交易中有足够的 EVM 计算：
```
仍使用 4/16 gas/byte
普通用户不受影响
```

### 技术实现

**Gas 计算公式**
```
标准 calldata gas = 零字节数 × 4 + 非零字节数 × 16

如果 (总 gas - calldata gas) < calldata gas × 系数:
    // 数据密集型交易
    实际 gas = 零字节数 × 10 + 非零字节数 × 40
else:
    // 计算密集型交易
    实际 gas = 标准 calldata gas
```

**阈值设计**
提案设置了一个阈值，确保：
- 有足够 [EVM](https://learnblockchain.cn/tags/EVM?map=EVM) 计算的交易不受影响
- 纯数据交易支付更高成本
- 平衡两类用户的需求

### 影响分析

**Rollup 的影响**

**使用 calldata 的 Rollup**
- 数据发布成本显著增加（2.5 倍）
- 强烈激励迁移到 blob（EIP-4844）
- 可能提高 L2 用户的交易费用

**已迁移到 blob 的 Rollup**
- 完全不受影响
- Blob 使用单独的费用市场
- 继续享受低成本数据可用性

**普通用户的影响**

**[DeFi](https://learnblockchain.cn/tags/DeFi?map=EVM) 交易**
- 涉及大量 [EVM](https://learnblockchain.cn/tags/EVM?map=EVM) 计算（Swap、流动性操作等）
- 计算 Gas >> calldata Gas
- 完全不受影响，保持 4/16 gas/byte

**简单转账**
- ETH 转账：21,000 gas，无 calldata
- [ERC-20](https://learnblockchain.cn/tags/ERC20?map=EVM) 转账：~50,000 gas，极少 calldata
- 影响可忽略不计

**合约部署**
- 部署涉及大量字节码
- 但同时有创建和初始化的计算
- 大部分情况不受影响

**数据密集型应用**
- 纯粹的数据存储或证明提交
- 成本增加 2.5 倍
- 应考虑使用 blob 或其他方案

### 对区块大小的影响

**最大区块大小**
```
旧方案：30M / 4 = 7.5 MB
新方案：30M / 40 = 0.75 MB

减少：约 90%
```

**实际影响**
- 极端情况下的区块大小大幅减少
- 区块大小方差降低
- 网络稳定性提高

**节点要求**
- 降低峰值带宽需求
- 减少存储增长速度（配合 EIP-4444）
- 提高节点运营的可持续性

### 与其他 EIP 的关系

**EIP-4844（Blob 交易）**
- 为 rollup 提供了低成本的数据可用性替代方案
- EIP-7623 激励 rollup 从 calldata 迁移到 blob
- 两者配合实现扩容

**EIP-4444（历史数据过期）**
- 减少新增的 calldata 数据量
- 配合历史数据修剪
- 控制长期存储增长

**EIP-7691（Blob 数量增加）**
- 提供更多 blob 空间
- Rollup 有足够的 blob 容量
- 使从 calldata 迁移更可行

### 实施状态

**激活信息**
- **升级名称**：Pectra（Prague-Electra）
- **激活时间**：2025 年 5 月 7 日
- **激活 epoch**：364032
- **网络**：[以太坊](https://learnblockchain.cn/tags/以太坊?map=EVM)主网

**客户端支持**
所有主流客户端已实现：
- Geth
- Nethermind
- Besu
- Erigon

### 社区反应

**支持的理由**
- 减少最大区块大小的不确定性
- 激励更高效的数据可用性使用
- 不影响普通用户
- 提高网络稳定性

**反对的担忧**
- 可能影响尚未迁移到 blob 的 rollup
- 增加某些应用的成本
- 复杂的定价机制

**最终共识**
经过充分讨论，社区认为收益大于成本：
- Blob 已经提供了更好的替代方案
- 限制区块大小方差有利于去中心化
- 普通用户不受影响

### 迁移建议

**对 Rollup**
1. **评估当前状态**
   - 检查是否使用 calldata 发布数据
   - 计算 EIP-7623 的成本影响

2. **迁移到 Blob**
   - 实现 blob 交易支持
   - 测试 blob 数据可用性
   - 逐步切换到 blob

3. **优化数据**
   - 压缩 calldata
   - 批处理优化
   - 减少不必要的数据

**对开发者**
1. **检查应用**
   - 评估是否为数据密集型
   - 计算成本影响

2. **考虑替代方案**
   - 使用链下存储 + 证明
   - 使用 blob 存储大量数据
   - 优化数据结构

3. **测试和监控**
   - 在测试网验证
   - 监控成本变化
   - 调整 Gas 估算

### 长期影响

**数据可用性市场**
- Blob 成为主要的数据可用性解决方案
- Calldata 用于需要即时可用性的小量数据
- 明确的功能分离

**网络健康**
- 更可预测的区块大小
- 降低节点运营成本
- 提高去中心化程度

**[Rollup](https://learnblockchain.cn/tags/Rollup) 生态**
- 加速向 blob 的迁移
- 更低的 L2 运营成本（通过 blob）
- 更可持续的扩容方案

### 经济模型

**费用燃烧**
Calldata [Gas](https://learnblockchain.cn/tags/Gas?map=EVM) 费用会燃烧 ETH：
- 数据密集型交易燃烧更多
- 但总交易量可能减少
- 净影响取决于 rollup 迁移速度

**[Gas](https://learnblockchain.cn/tags/Gas?map=EVM) 市场**
- Calldata 和 blob 的费用市场分离
- [Rollup](https://learnblockchain.cn/tags/Rollup) 可以选择最经济的方案
- 市场驱动的资源分配

### 监控指标

**关键指标**
- 平均区块大小
- 最大区块大小
- Calldata 使用量
- Blob 采用率
- 节点同步时间

**预期效果**
- 最大区块大小显著降低
- Blob 使用率增加
- 网络更加稳定

### 相关链接

- [EIP-7623 官方规范](https://learnblockchain.cn/docs/eips/EIPS/eip-7623)
- [EIP-7623 分析（HackerNoon）](https://hackernoon.com/eip-7623-the-proposal-that-will-re-price-calldata-for-ethereum-transactions)
- [Pectra 升级总览](https://ethereum.org/roadmap/pectra/)
- [EIP-4844 Blob 交易](https://learnblockchain.cn/docs/eips/EIPS/eip-4844)
