## 合约工厂 (Contract Factory)

合约工厂是一种智能合约设计模式，指一个合约（工厂合约）的主要功能是部署和管理其他合约（子合约）。

### 解决的问题
在去中心化应用（DApp）中，经常需要动态创建多个结构相同但初始化参数不同的合约实例，例如：
*   为每个用户创建一个专属的钱包合约。
*   为每个交易对创建一个流动性池合约（如 Uniswap）。
*   为每个新的众筹项目创建一个募资合约。
如果由外部账户（EOA）手动部署这些合约，操作繁琐、难以跟踪且 Gas 成本可能较高。合约工厂模式将部署逻辑封装在链上，实现了合约创建的自动化、标准化和可追踪性。

### 实现机制与原理
合约工厂通常利用 Solidity 的 `new` 关键字或 `create2` 操作码来部署新合约。
1.  **使用 `new` 关键字:** 工厂合约中导入子合约的定义，调用 `new ChildContract(params)` 即可部署一个新实例。新合约的地址由工厂合约地址和其 nonce 决定。
2.  **使用 `create2` (确定性部署):** 允许在部署前就预测出新合约的地址。地址由工厂合约地址、盐值（salt）和子合约的字节码决定，与 nonce 无关。这对于状态通道及某些交互场景非常有用。
3.  **最小代理 (Minimal Proxy / EIP-1167):** 为了节省 Gas，工厂不直接部署完整的合约代码，而是部署一个非常小的代理合约，该代理直接 `delegatecall` 到一个预先部署好的“实现合约”。这样，无论创建多少个实例，都只需存储一份逻辑代码。

### 主要特点
*   **自动化部署:** 允许用户或其他合约通过简单的函数调用在链上创建新合约。
*   **统一管理:** 工厂合约通常会维护一个注册表（如数组或映射），记录所有已部署子合约的地址，便于索引和查询。
*   **节省 Gas:** 结合最小代理模式（Clones），可以极大地降低批量部署合约的成本。
*   **标准化:** 确保所有生成的子合约都遵循相同的代码模板和初始化流程。
*   **可预测性:** 使用 `create2` 可以实现反事实实例化（Counterfactual Instantiation），即在合约部署前就能向其发送资金。

### 推荐阅读
*   [Solidity Docs: Creating Contracts](https://docs.soliditylang.org/en/latest/control-structures.html#creating-contracts)
*   [EIP-1167: Minimal Proxy Contract](https://eips.ethereum.org/EIPS/eip-1167)

### 相关概念
*   **Create2:** 用于确定性部署合约的 EVM 操作码。
*   **Clone/Minimal Proxy:** 低成本复制合约逻辑的模式。
*   **Registry:** 用于记录和查询已部署合约地址的系统。
