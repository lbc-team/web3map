## 合约升级 (Contract Upgrade)

合约升级是指在以太坊等区块链上，通过特定的设计模式改变智能合约的逻辑或修复漏洞，同时保留原有合约状态（数据）和地址（通常通过代理实现）的过程。

### 解决的问题
区块链上的智能合约一旦部署，其代码就是不可变的（Immutable）。这意味着如果发现漏洞、需要添加新功能或修改业务逻辑，无法直接在原地址修改代码。合约升级模式解决了这一问题，允许开发者在不通过硬分叉或迁移大量用户数据的情况下“更新”合约逻辑。

### 实现机制与原理
最常见的合约升级机制基于 **代理模式 (Proxy Pattern)**，利用 `delegatecall` 操作码。
1.  **代理合约 (Proxy Contract):** 用户直接交互的合约。它存储所有的状态变量（数据）和资产（如 ETH 或 Token），但不包含具体的业务逻辑。它包含一个指向逻辑合约地址的指针。
2.  **逻辑合约 (Logic/Implementation Contract):** 包含实际业务逻辑代码的合约。它不存储状态，只提供代码供代理合约执行。
3.  **Delegatecall:** 当用户调用代理合约时，代理合约通过 `delegatecall` 将调用转发给逻辑合约。`delegatecall` 的关键特性是代码在逻辑合约中执行，但**上下文（Context）**（包括存储 `Storage`、`msg.sender`、`msg.value`）保留在代理合约中。这意味着逻辑合约的代码在修改代理合约的存储。
4.  **升级过程:** 要升级合约，只需部署一个新的逻辑合约，然后调用代理合约的管理函数，将其指向新逻辑合约的地址。

常见的升级模式包括：
*   **透明代理 (Transparent Proxy):** 通过分离管理员和普通用户的调用路径，解决函数选择器冲突问题。
*   **UUPS (Universal Upgradeable Proxy Standard):** 将升级逻辑放在逻辑合约中，通过 `delegatecall` 执行升级，节省了代理合约的 Gas。
*   **钻石标准 (Diamond Standard / EIP-2535):** 允许一个代理合约委托给多个逻辑合约（Facets），支持突破合约大小限制和更细粒度的升级。

### 主要特点
*   **代码可变性:** 允许修复 Bug 和添加新功能。
*   **状态保留:** 升级过程中保留用户数据和余额，无需迁移。
*   **地址不变:** 用户始终与同一个代理合约地址交互。
*   **复杂性:** 引入了额外的复杂性，如存储布局冲突（Storage Collision）风险，需要严格的开发规范。
*   **中心化风险:** 升级权限通常掌握在管理员或多签钱包手中，存在单点信任问题。

### 推荐阅读
*   [OpenZeppelin Proxy Upgrade Pattern](https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies)
*   [EIP-2535: Diamond Standard](https://eips.ethereum.org/EIPS/eip-2535)

### 相关概念
*   **Delegatecall:** 实现代理模式的核心 EVM 操作码。
*   **Storage Layout:** 合约状态变量在存储中的排列方式，升级时必须保持一致。
*   **Timelock (时间锁):** 用于延迟执行升级操作，给用户反应时间的治理机制。
*   **Admin/Owner:** 拥有升级权限的账户或合约。
