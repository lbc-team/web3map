## 离线签名 (Offline Signature)

离线签名（Offline Signature）是指用户在不直接向区块链广播交易的情况下，使用私钥对特定数据进行签名的过程。这个签名随后可以由任何人（或其他合约）在链上验证。

### 解决的问题
传统的以太坊交互要求用户为每一个操作（如授权代币、投票）发起一笔交易并支付 Gas 费。这导致了以下问题：
*   **用户体验差:** 用户需要等待交易确认。
*   **成本高:** 简单的意图表达（如投票）也需要支付 Gas。
*   **无法代付 Gas:** 发起交易的账户必须持有 ETH。

离线签名技术通过允许用户在链下签署数据（意图），然后由他人（Relayer）提交上链，解决了上述问题。这实现了“元交易 (Meta-Transactions)”和“无 Gas 交易 (Gasless Transactions)”。

### 实现机制与原理
以太坊主要的离线签名标准包括：

1.  **EIP-191 (Signed Data Standard):**
    *   定义了签名的基本格式：`0x19 <1 byte version> <version specific data> <data to sign>`。
    *   最常用的是 `personal_sign` (version `0x45`)，它会在消息前加上前缀 `\x19Ethereum Signed Message:\n<length>`。这样做是为了防止签名被误用为合法的以太坊交易（以太坊交易是 RLP 编码的，不以 `0x19` 开头）。

2.  **EIP-712 (Typed Structured Data Hashing and Signing):**
    *   **问题:** EIP-191 签名的通常是一串晦涩的哈希值，用户在钱包签名时无法看懂自己签的是什么，存在盲签风险。
    *   **解决方案:** EIP-712 定义了一种结构化数据（类似 JSON 对象）的哈希标准。钱包可以解析这种结构并在界面上清晰地展示数据的具体字段（如 To: Alice, Amount: 100），让用户明确知道自己在签署什么。
    *   **Domain Separator:** EIP-712 引入了域分隔符（包含合约地址、ChainID 等），防止签名在不同的 DApp 或不同的链之间被重放。

### 主要特点
*   **Gas 优化:** 签名本身不上链，不消耗 Gas。
*   **用户体验:** 这种“签名即意图”的模式使得交互更流畅。
*   **安全性:** EIP-712 极大地提高了签名的可读性和安全性。
*   **元交易:** 允许第三方（Relayer）代替用户提交交易并支付 Gas，用户只需提供签名。

### 常见应用场景
*   **Permit (ERC-2612):** 允许用户通过签名授权代币转账额度，而无需先发送一笔 `approve` 交易。
*   **DEX 挂单:** 如 OpenSea 或 Uniswap X，用户签名挂单，仅在成交时才上链。
*   **链下投票:** 如 Snapshot，用户签名投票，结果存储在 IPFS 上。
*   **登录认证:** 使用 `Sign-in with Ethereum (SIWE)` 进行身份验证。

### 推荐阅读
*   [EIP-712: Typed structured data hashing and signing](https://eips.ethereum.org/EIPS/eip-712)
*   [EIP-2612: Permit Extension for ERC20](https://eips.ethereum.org/EIPS/eip-2612)

### 相关概念
*   **ECDSA:** 椭圆曲线数字签名算法，以太坊使用的签名算法。
*   **ecrecover:** Solidity 内置函数，用于从签名中恢复出签名者的地址。
*   **Replay Attack:** 重放攻击，通过 Domain Separator 和 Nonce 来防止。
