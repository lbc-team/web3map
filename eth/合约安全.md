# 合约安全

智能合约安全是指在设计、开发、测试和部署智能合约过程中，采取的一系列保护措施、最佳实践和验证方法，旨在防止代码漏洞、逻辑缺陷和经济攻击，确保合约资产和状态的安全。

## 要解决的问题

智能合约与传统软件开发相比，面临着极为独特的安全挑战：

1.  **不可篡改性**：合约一旦部署在区块链上，代码通常无法修改。如果发现漏洞，无法像传统软件那样简单地发布补丁。
2.  **高价值目标**：智能合约通常直接托管加密资产（代币、NFT、资金池），这使其成为黑客极具诱惑力的攻击目标。
3.  **公开透明**：合约的字节码和所有交易数据都是公开的，攻击者可以离线分析代码，寻找漏洞。
4.  **可组合性风险**：DeFi 协议之间的复杂交互（如闪电贷）可能引入单一合约中不存在的系统性风险。

## 实现机制与原理

合约安全不是单一的技术，而是一个多层防御体系。

### 常见漏洞类型
理解攻击原理是防御的基础。常见的安全漏洞包括：
*   **重入攻击（Reentrancy）**：恶意合约在被调用时，反向回调原合约，在原合约更新状态之前重复提取资金（如 The DAO 事件）。
*   **整数溢出/下溢（Overflow/Underflow）**：在 Solidity 0.8.0 之前，超过变量存储范围的计算会导致数值回绕。
*   **访问控制缺失**：未正确限制敏感函数（如 `withdraw`, `mint`）的调用权限。
*   **预言机操纵**：依赖单一或易被操纵的价格来源，导致资产定价错误。

### 防御策略
1.  **检查-生效-交互（Checks-Effects-Interactions）模式**：首先验证所有条件（Checks），然后更新合约状态（Effects），最后才与外部合约交互（Interactions）。这能有效防止重入攻击。
2.  **最小权限原则**：使用 `Ownable` 或 `AccessControl` 严格限制特权操作，并考虑使用多重签名钱包或时间锁（Timelock）管理管理权限。
3.  **使用经过审计的库**：避免造轮子，使用 OpenZeppelin 等经过广泛验证的安全合约库。

### 验证与审计
*   **静态分析**：使用自动化工具扫描代码中的已知漏洞模式。
*   **形式化验证**：通过数学方法证明合约逻辑符合特定的安全属性规范。
*   **代码审计**：由专业的第三方安全公司对代码进行人工审查，寻找逻辑缺陷和经济模型漏洞。

## 主要特点

*   **对抗性思维**：合约安全要求开发者像攻击者一样思考，假设所有外部调用都是恶意的。
*   **经济安全性**：除了代码逻辑，还必须考虑博弈论和激励机制，防止经济层面的攻击（如闪电贷攻击）。
*   **不可逆性**：安全事故造成的损失通常是不可挽回的，这极大地提高了安全工程的门槛和重要性。

## 推荐阅读

*   [SWC Registry (Smart Contract Weakness Classification)](https://swcregistry.io/)
*   [OpenZeppelin Security Best Practices](https://docs.openzeppelin.com/learn/upgrading-smart-contracts)
*   [Ethereum Smart Contract Security Best Practices (ConsenSys)](https://consensys.github.io/smart-contract-best-practices/)
*   [Ethernaut CTF](https://ethernaut.openzeppelin.com/) (通过游戏学习合约安全)

## 相关概念

*   **形式化验证 (Formal Verification)**
*   **Bug Bounty (漏洞赏金)**
*   **审计 (Audit)**
*   **闪电贷 (Flash Loan)**
