## Tower BFT

Tower BFT 是 [Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 的共识算法，它是一种基于历史证明（PoH）优化的实用拜占庭容错（PBFT）算法。Tower BFT 利用 PoH 作为全局时钟，使验证者能够在不需要大量消息传递的情况下达成共识，从而实现高吞吐量和低延迟。

### 核心设计

**传统 PBFT 的局限**
传统的 PBFT 算法要求验证者之间进行多轮消息交换来就交易顺序达成一致。在 n 个验证者的网络中，消息复杂度为 O(n²)，这限制了网络的可扩展性。

**Tower BFT 的创新**
Tower BFT 通过引入 PoH 作为可信的时间源，将共识问题简化为：
1. 验证者观察 PoH 时间链
2. 基于 PoH 时间戳对交易排序
3. 通过投票确认区块

这种设计将消息复杂度降低到 O(n)，显著提升了可扩展性。

### 工作机制

**1. 投票与超时**
验证者为区块投票时，会设置一个"锁定超时"（lockout）。随着投票深度增加，超时时间呈指数增长：
- 第 1 次投票：锁定 2 个 slot
- 第 2 次投票：锁定 4 个 slot
- 第 3 次投票：锁定 8 个 slot
- ...
- 第 32 次投票：锁定约 2³² 个 slot（最终确认）

**2. 投票堆栈**
验证者维护一个投票堆栈，记录每次投票及其锁定时间。只有当锁定时间过期后，验证者才能切换到其他分叉。

**3. Rollback 防护**
由于锁定时间呈指数增长，回滚深度较大的区块需要验证者承担很长的锁定期。这使得攻击者很难重组已确认的交易。

**4. 最终性**
当一个区块获得足够多验证者的第 32 次确认投票时，它达到最终性（finalized），不可逆转。

### 关键特性

**快速确认**
- **Processed**：交易被打包进区块（<1 秒）
- **Confirmed**：区块获得超过 2/3 质押权重的投票（约 400-600 毫秒）
- **Finalized**：区块获得 32 次确认，完全不可逆（约 13-15 秒）

**分叉选择**
验证者选择分叉时遵循以下规则：
1. 选择获得最多质押权重投票的分叉
2. 如果权重相同，选择最长的 PoH 链
3. 遵守自己的锁定超时约束

**乐观确认**
在大多数验证者诚实的情况下，交易在 1-2 次投票后就有很高的确定性，即使尚未达到最终确认。这使得 [Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 能够提供亚秒级的用户体验。

### 与其他共识的对比

| 特性 | Tower BFT | Tendermint | Nakamoto | Ethereum PoS |
|------|-----------|------------|----------|--------------|
| 消息复杂度 | O(n) | O(n²) | O(n) | O(n) |
| 最终性 | 概率性→确定性 | 确定性 | 概率性 | 确定性 |
| 确认时间 | 400ms→13s | 1-6s | 10-60min | 12-19min |
| 吞吐量 | 极高 | 中等 | 低 | 中等 |
| 依赖 | PoH | 同步时钟 | 最长链 | 时隙 |

### 安全性保证

**拜占庭容错**
Tower BFT 可以容忍最多 1/3 的验证者（按质押权重）出现故障或作恶。只要诚实验证者控制超过 2/3 的质押，网络就能正常运行。

**经济安全**
攻击者要重组已确认的交易，需要控制超过 1/3 的质押权重，并承担长时间的锁定期，这在经济上是不划算的。

### 相关概念

- **PoH（历史证明）**：Tower BFT 的基础，提供可验证的时间顺序
- **PBFT**：实用拜占庭容错，Tower BFT 的理论基础
- **Slot**：[Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 的时间单位，约 400 毫秒
- **Epoch**：一组 slot 的集合，[Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 中约 2-3 天
