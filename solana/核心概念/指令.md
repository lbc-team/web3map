## 指令

指令（Instruction）是 Solana 交易的基本组成单元，每个指令调用一个程序（Program）执行特定操作。一个交易可以包含多个指令，它们按顺序执行，具有原子性。

### 指令结构

一个指令包含三个核心部分：

**1. 程序 ID（Program ID）**
- 要调用的程序地址
- 例如：System Program, Token [Program](https://learnblockchain.cn/tags/Program?map=Solana), 自定义程序

**2. 账户列表（Accounts）**
指令需要访问的所有账户，每个账户包含：
- **Pubkey**：账户地址
- **is_signer**：是否需要签名
- **is_writable**：是否可写

**3. 指令数据（Instruction Data）**
- 传递给程序的参数
- 序列化的字节数组
- 程序根据数据执行不同操作

### 指令示例

**转账指令**
```rust
let instruction = solana_sdk::system_instruction::transfer(
    &sender_pubkey,
    &receiver_pubkey,
    lamports,
);
```

这个指令包含：
- 程序 ID：System [Program](https://learnblockchain.cn/tags/Program?map=Solana)
- 账户：sender（可写，签名者）、receiver（可写）
- 数据：转账金额

### 账户权限

账户在指令中的权限标记：

**is_signer**
- 要求账户持有者签名
- 用于验证授权
- 通常是用户钱包或 PDA

**is_writable**
- 账户数据可被修改
- lamports 余额可能变化
- 只读账户可并行访问

**权限示例**
```rust
AccountMeta {
    pubkey: user_account,
    is_signer: true,   // 需要签名
    is_writable: true,  // 可写
}
```

### 指令执行

**顺序执行**
交易中的指令按定义顺序依次执行：
1. 第一个指令
2. 第二个指令
3. ...

如果任一指令失败，整个交易回滚。

**账户锁定**
执行时，Solana 会锁定指令涉及的账户：
- 可写账户独占锁定
- 只读账户可被多个指令共享

这使得 [Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 能并行执行不冲突的交易。

### 跨程序调用（CPI）

程序可以在指令中调用其他程序：

```rust
invoke(
    &instruction,
    &[account1, account2, account3],
)?;
```

**CPI 特性**
- 调用深度限制为 4 层
- 被调用程序继承调用者的权限
- 可以通过 [PDA](https://learnblockchain.cn/tags/PDA?map=Solana) 签名

**[CPI](https://learnblockchain.cn/tags/CPI?map=Solana) 用例**
- Token 转账
- 调用 Oracle 获取价格
- 组合多个 DeFi 协议

### 常见指令类型

**1. 系统指令**
- 创建账户
- 转账 SOL
- 分配空间
- 分配所有者

**2. Token 指令**
- 初始化 Token
- 铸造 Token
- 转账 Token
- 销毁 Token

**3. 自定义指令**
开发者定义的程序指令：
```rust
pub enum MyInstruction {
    Initialize { amount: u64 },
    Deposit { amount: u64 },
    Withdraw { amount: u64 },
}
```

### 指令数据序列化

**Borsh 序列化**
[Solana](https://learnblockchain.cn/tags/Solana?map=Solana) 推荐使用 Borsh 格式：
```rust
#[derive(BorshSerialize, BorshDeserialize)]
pub struct InitializeData {
    pub amount: u64,
    pub authority: Pubkey,
}
```

**手动序列化**
```rust
let mut data = vec![0]; // 指令标识
data.extend_from_slice(&amount.to_le_bytes());
```

### 指令优化

**1. 减少账户数量**
- 合并相关账户
- 使用 [PDA](https://learnblockchain.cn/tags/PDA?map=Solana) 存储多个数据

**2. 批量操作**
- 在一个指令中处理多个操作
- 减少 [CPI](https://learnblockchain.cn/tags/CPI?map=Solana) 调用

**3. 预加载账户**
- 提前验证账户
- 减少重复检查

### 最佳实践

**1. 明确账户权限**
只标记必要的账户为可写或签名者，提高并行性。

**2. 验证输入**
在程序中检查：
- 账户所有者
- 账户数据有效性
- 权限正确性

**3. 错误处理**
返回清晰的错误信息：
```rust
if !user.is_signer {
    return Err(ProgramError::MissingRequiredSignature);
}
```

### 相关概念

- **交易（Transaction）**：包含一个或多个指令的原子操作单元
- **程序（[Program](https://learnblockchain.cn/tags/Program?map=Solana)）**：指令调用的目标，执行业务逻辑
- **[CPI](https://learnblockchain.cn/tags/CPI?map=Solana)（跨程序调用）**：指令中调用其他程序
- **账户（Account）**：指令操作的数据和状态存储
