# 闪电网络

## 什么是闪电网络？

闪电网络（LN）是位于比特币之上的L2支付协定。旨在实现参与节点之间的快速交易，并已被提议作为比特币可扩展性问题的解决方案。该方案有点对点系统，可通过双向支付渠道网路对加密货币进行小额支付，而无需委托保管资金。

闪电网络的主要是实现是，支付的双方在链下建立一个"通道"，双方可以在这个“通道”多次进行支付交易，在需要结算时，关闭通道即可。当支付的双方没有直接的"通道"时可以借助第三方节点进行中转。

## 闪电网络优缺点

与比特币链上交易相比，闪电网络有几个**好处**：

+ **更低的交易费用，对小额交易非常友好**，由于比特币链上交易需要用户之间相互竞价，比特币上一笔交易手续费通常在几美金，巅峰时期这需要几十美金，对于小额的交易，手续费往往比转移的金额还要多，闪电网络上通道费用是动态的，通常按转移的BTC数量的万分之几收取。

+ 在闪电网络协议下每秒可以发生的**支付数量没有基本限制**，仅受每个节点的容量和速度限制。

+ **更好的隐私**，闪电网络支付的细节不会公开记录在区块链上。闪电网络支付可以通过许多连续的通道进行路由，每个节点运营商都可以通过他们的通道看到支付，但如果不相邻，他们将无法看到这些资金的来源或目的地。

同时，闪电网络也有一些**限制**：

+ 闪电网络要求节点一直保持在线以充当支付通道，比较容易受到黑客攻击和盗窃。
+ 多个用户可能会依赖某个关键枢纽节点，这样的枢纽的离线会迅速带来网络的集体（或完全）崩溃。

## 相关概念

### <u>LUNRL</u>

LNURL 是由多个简单协议构成的堆栈，用于通过 HTTP 协调在闪电网络上完成付款所需的信息。

LNURL 协议的三个核心组件分别是：一个可以让用户使用公钥登录服务的身份验证方案、一个可以让钱包通过静态二维码向服务器发送请求并获取发票的发票请求方案，以及一个可以让钱包请求服务器支付其所提供发票的取款请求方案。闪电网络发票比链上比特币地址长得多，付款本身就是需要双方都在线的交互过程，因此通过网络连接交互式协调付款信息是合情合理的。

**三个核心组件详述**：

* **身份验证协议**实际上就是服务器提供一个随机生成的数字，由用户钱包使用新生成的密钥签名。在收到随机数的签名后，服务器会保存相关公钥，以便以后登录使用。

* **发票请求**功能以非发票形式提供用户完成付款所需信息。这些信息包括付款描述、预期需要向服务方支付的最低和最高金额，以及让钱包能够请求到真正发票的 URL。钱包会将上述信息展示给用户，由用户设定最终金额并请求发票。将发票请求发送给服务器并从服务器那里获得发票后，钱包会验证发票金额是否符合用户设定金额，并支付发票。

* **取款请求**的运作方式是，向服务方发送信息，接收返回的描述、用于发送发票的 URL、随机字符串（或与账户或用户绑定的确定性字符串），以及最低和最高取款额。填写完恰当的值后，钱包会将发票返回给服务器。如果填写的值有效，并且位于金额参数的范围内，服务方就会支付发票。LNURL 身份验证协议可以搭配使用，确保只有目标用户才能通过 LNURL 链接成功完成取款。

LNURL 已经得到改进，极大提升了闪电网络的使用体验，但是必须使用 web 服务器。所有请求和响应都通过 HTTP 处理，而且除了闪电网络节点之外，还需要其它基础设施来简化协调和付款流程。对于任何线上服务提供商或商户来说，这都是个非常合理的要求，因为他们无论如何都需要一个 web 服务器来提供在线服务或产品。但是，对于想要获得这种流畅体验却又不懂技术的宅家用户、小摊贩、实体店和其他无需使用 web 服务器的用户来说，这确实是个麻烦而且存在安全隐患的要求。

### <u>BOLT12</u>

“BOLT” 是 “闪电网络技术基础（Basis of Lightning Technology）” 的缩写，是一种技术规范的草案。

BOLT12是一种新的闪电网络发票规范，其包含一种新的发票：“offer”。可以认为 “offer” 是一种 “超” 发票 ， 一个发票之上的一个发票。对比于BOLT11，其做出了更多的改进。

BOLT 12 无需 web 服务器就可以实现 LNURL 提供的部分核心功能。请求发票所必需的信息，要么是 node_id，要么是通过洋葱消息与节点通信的盲化路径（即洋葱路由的最后几跳，是预先计算和加密的）。洋葱消息功能可以让节点在不依赖闪电网络通道的情况下直接进行端到端加密通信。就像闪电网络付款那样，这些信息可以用于洋葱路由消息。获取要约后，付款方会使用要约中编码的信息发送一条发票请求。然后，要约的创建者将返回真正的发票。

BOLT 12 还可以为每位用户生成独特的要约，以便接收方向要约的创建者请求付款，类似 LNURL 的取款请求功能。BOLT 12 发票承诺付款方密钥的唯一性——如果发生退款的情况，付款方密钥可用来证明谁是真正支付发票的人。密钥唯一性也可以跟取款要约搭配使用，确保只有真正的接收方才能成功获取创建者支付的发票，不像要约副本那样人人皆可获取。

要约的两个用法有效实现了类似 LNURL 的发票和取款请求功能，无需运行 web 服务器。

#### BOLT12应用场景

* **订阅服务**：BOLT12 offer 可以要求用户每天、每周或者每个月支付一次发票（以美元或者以聪计价）。钱包依然需要构建这个功能，但是基础设施将就绪。

* **比特币闪电网络ATM**：Offer 可以通过信用发票的形式，给你发送资金。这在之前是不可能的。这可以实现更好的用户体验，推动闪电网络的普及。

* **隐私退款**：在退款时，用户无需创建一个发票并发送给商家，用户可以扫描一个 “退款” offer，然后收回自己的钱。这对接收者来说更加隐私，而且整体上用户体验也比较好。

***

参考文章：

1.https://www.btcstudy.org/2022/07/04/bolt12-lnurl-and-bitcoin-lightning/

2.https://twitter.com/LN_Capital/status/1589321548133203968
