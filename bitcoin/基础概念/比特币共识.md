# 比特币共识

## 介绍

***

由于比特币采用去中心化的区块链设计，节点各处分散且平行。因此必须要设计一套制度来维护系统的运作顺序与公平性，统一区块链的版本，并且奖励提供资源来维护区块链的使用者，以及惩罚恶意危害着。共识机制就此产生。共识机制需要解决的根本问题是：某个节点如何添加一个区块到区块链中而得到全网的同意。

共识机制需要同时满足两个性质：**一致性**，所有诚实节点保存的区块链的前缀部分完全相同；**有效性**，由某诚实节点发布的信息终将被其他所有诚实节点记录在自己的区块链中。

采用投票的机制来达成共识是否可行呢？比如某个节点打包了一个区块并向全网广播，其他节点收到后会进行核验，若正确则投赞成票，不正确则投反对票，赞成票过半就添加到区块链中。然而这样做会产生很多问题，比如网络延迟、存在恶意节点投票或者是造成女巫攻击（模仿多种身份进行攻击）。

比特币中采用了一种巧妙的方案：POW工作量证明，即通过算力进行投票。

## POW工作量证明

***

![工作量证明流程](/graph/%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E6%B5%81%E7%A8%8B.png)

### POW原理

工作量证明的本质是：尝试大量随机数进行哈希运算。具体为找到一个随机数加入到块头中，计算区块的块头的哈希值，使得计算的哈希结果小于或等于块头中目标值。若不满足目标条件，则重新找随机数进行重复操作，直到满足目标条件为止。在比特币中使用的哈希函数为**SHA256算法函数**，是密码哈希函数家族中输出值为256位的哈希算法。

> 公式为：H(block header + nonce) <=target

根据哈希性质之一：谜题友好性（puzzle friendly），计算的哈希值结果是不可预测的，比如某个输入x，想要哈希值H(x)在某个范围内，没有什么捷径可走，只能一个个去尝试这个x（因此要做大量工作）。之所以只计算区块块头的哈希值而不包含区块体，是因为在块头中的根哈希值（merkle root hash）保证了区块体中的内容不被篡改。

### POW对恶意节点防范

* POW共识机制是根据算力来竞争记账权的，恶意节点产生再多的账户也没用。（针对女巫攻击）
* POW要求要找到正确的nonce值才能广播到全网中，而不断打包非法交易显然是对自己没有任何好处的，因为会消耗不小的经济成本，包括硬件设施、电力、维护等等。

### POW奖励机制

比特币系统中规定，只要工作量证明在全网达成共识并加入到区块链中后就可以获得比特币，也就是出块奖励（block reward）。比特币的来源就是通过出块奖励产生，也是比特币增多的唯一来源。

**奖励规则**：比特币系统中维持着平均每10分钟会有一个工作量证明成功（挖矿成功）。比特币系统最初始的挖矿奖励是50BTC，区块链中的区块每21万个后奖励就减半，也就是25BTC，以此类推。

- **计算BTC奖励减半的时间**

根据2个条件：

1.平均每10分钟出一个块（挖矿成功）

2.每21万个区块后奖励减半

那么开采21万个区块所需的时间：

**210000*10/60/24/365= 3.995年**

计算得到时间为 3.995年，约等于4年。也就是说比特币奖励大约每4年减半。

也就是大约到2140年左右比特币将不再增长，达到饱和。矿工挖矿不再获得奖励。

***

参考文章：https://zhuanlan.zhihu.com/p/112477662

