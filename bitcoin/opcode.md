# 操作码 (Opcode)

操作码（Opcode，Operational Code 的缩写）是比特币脚本语言（Script）中的基本指令单元。比特币使用一种基于堆栈的、非图灵完备的脚本语言来定义交易的锁定和解锁条件。每一个操作码代表一个特定的动作，如数据入栈、算术运算、逻辑判断或加密验证。

## 要解决的问题

数字货币系统需要一种机制来定义资金的所有权和花费条件。简单的“账户-余额”模型（如银行系统）缺乏灵活性，无法支持复杂的多重签名、时间锁定或条件支付。

操作码体系解决的核心问题是**“可编程货币”的表达能力与安全性的平衡**：
1.  **灵活性**：允许用户自定义复杂的支付条件（例如：“必须由A和B共同签名，或者由A在30天后单独签名才能花费”）。
2.  **安全性**：通过限制语言的图灵完备性（没有循环结构），避免了死循环（Infinite Loops）导致的网络拒绝服务攻击（DoS），确保每笔交易的验证成本是可预测且有限的。

## 实现机制与原理

比特币脚本是**基于堆栈（Stack-based）**的，这意味着指令是按顺序执行的，数据被推入（Push）堆栈顶部或从顶部弹出（Pop）进行处理。

### 脚本执行流程
当一笔交易试图花费之前的输出（UTXO）时，比特币网络会执行两段脚本：
1.  **解锁脚本（ScriptSig）**：由发送者提供，通常包含签名和公钥。
2.  **锁定脚本（ScriptPubKey）**：存在于之前的 UTXO 中，定义了花费该资金必须满足的条件。

节点将解锁脚本和锁定脚本拼接在一起（解锁脚本在前），然后按顺序逐个处理操作码。如果执行结束时，堆栈顶部元素为“真”（True，非零值），则交易验证通过。

### 操作码分类
比特币包含约 100 多个有效的操作码，主要分为：
*   **常量与数据推送**：如 `OP_0` (推入0), `OP_PUSHDATA` (推入数据)。
*   **流程控制**：如 `OP_IF`, `OP_ELSE`, `OP_VERIFY` (验证并可能终止执行)。
*   **堆栈操作**：如 `OP_DUP` (复制栈顶元素), `OP_DROP` (移除栈顶元素).
*   **算术与逻辑**：如 `OP_ADD` (加法), `OP_EQUAL` (判断相等).
*   **加密与锁定**：如 `OP_SHA256` (哈希计算), `OP_CHECKSIG` (验证签名), `OP_CHECKMULTISIG` (验证多重签名).

## 主要特点

*   **非图灵完备（Non-Turing Complete）**：为了安全起见，比特币脚本不支持 `OP_LOOP` 等循环指令。这消除了停机问题的风险。
*   **无状态（Stateless）**：脚本验证仅依赖于交易本身的数据和区块链的当前状态，不依赖于外部状态或其他交易的历史执行结果。
*   **后缀波兰表示法（Reverse Polish Notation）**：操作符位于操作数之后，适合堆栈机处理。
*   **软分叉扩展性**：通过 `OP_NOP`（无操作）操作码或重定义现有操作码（如 Taproot 升级），比特币可以在不破坏向后兼容性的前提下引入新功能。

## 推荐阅读

*   [Bitcoin Wiki: Script](https://en.bitcoin.it/wiki/Script)
*   [Bitcoin Opcode Reference](https://en.bitcoin.it/wiki/Script#Opcodes)
*   [Mastering Bitcoin - Chapter 6: Transactions](https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc)

## 相关概念

*   **UTXO**：未花费交易输出，比特币交易的基本构建块，包含锁定脚本。
*   **P2PKH**：Pay to Public Key Hash，最常见的比特币交易类型，使用标准的操作码序列。
*   **Tapscript**：随着 Taproot 升级引入的脚本版本，对原有操作码进行了优化和扩展。
