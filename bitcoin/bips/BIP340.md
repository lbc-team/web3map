# BIP340 - Schnorr 签名

BIP340（Bitcoin Improvement Proposal 340）是比特币改进提案之一，由 Pieter Wuille、Jonas Nick 和 Tim Ruffing 在 2020 年提出，定义了在 secp256k1 椭圆曲线上使用 Schnorr 签名的标准。这是比特币协议的重大技术升级，为 Taproot（BIP341）和 Tapscript（BIP342）奠定了基础。

## 核心概念

Schnorr 签名是一种数字签名方案，由德国数学家和密码学家 Claus Schnorr 在 1989 年提出。相比比特币长期使用的 ECDSA（椭圆曲线数字签名算法），Schnorr 签名具有更优的数学特性，包括可证明的安全性、线性特性和更高的效率。

BIP340 是 Schnorr 签名在比特币中的具体实现规范，它定义了：
- 签名和验证算法
- 公钥和签名的序列化格式
- 批量验证方法

## 主要特性

### 1. 签名聚合

Schnorr 签名的线性特性使得多个签名可以聚合为一个签名：

```
sig(k1 + k2, m) = sig(k1, m) + sig(k2, m)
```

这意味着：
- 多重签名交易可以合并为单一签名
- 显著减少交易大小和验证成本
- 提高隐私性，外部无法区分单签名和多签名

### 2. 密钥聚合

多个公钥可以聚合为一个公钥：
- 多方可以协作生成一个联合公钥
- 只需一个签名即可证明所有方的授权
- 使用 MuSig2 等协议实现安全的多方签名

### 3. 固定大小签名

BIP340 定义的签名固定为 64 字节：
- 相比 ECDSA 的 71-72 字节更紧凑
- 公钥为 32 字节（仅 x 坐标）
- 简化了序列化和存储

### 4. 批量验证

支持高效的批量签名验证：
- 可以同时验证多个签名
- 验证速度提升约 2-3 倍
- 对于区块验证特别有用

### 5. 可证明安全性

Schnorr 签名在随机预言机模型下具有可证明的安全性：
- 基于离散对数困难性假设
- 相比 ECDSA 有更强的理论基础
- 减少了潜在的安全漏洞

## 技术细节

### 公钥格式

BIP340 使用 32 字节的公钥格式：
- 仅包含椭圆曲线点的 x 坐标
- y 坐标隐含为偶数（通过选择确保）
- 显著节省空间，相比传统 33 字节压缩公钥

### 签名格式

签名由两部分组成（各 32 字节）：
```
signature = (R, s)
```
- R：随机点的 x 坐标（32 字节）
- s：签名标量（32 字节）
- 总计 64 字节固定大小

### 签名生成算法

1. 生成随机数 k
2. 计算 R = k·G（G 为生成元）
3. 如果 R 的 y 坐标为奇数，则取反 k
4. 计算挑战值 e = hash(R.x || P || m)
5. 计算 s = k + e·d（d 为私钥）
6. 返回签名 (R.x, s)

### 验证算法

1. 解析签名为 (r, s)
2. 计算挑战值 e = hash(r || P || m)
3. 计算点 R' = s·G - e·P
4. 验证 R'.x == r 且 R'.y 为偶数

## 技术优势

### 空间效率

- **签名大小**：64 字节（ECDSA 为 71-72 字节）
- **公钥大小**：32 字节（压缩 ECDSA 为 33 字节）
- **多重签名**：N-of-N 多签只需 1 个签名（ECDSA 需要 N 个）

### 性能优势

- **验证速度**：单个签名验证与 ECDSA 相当
- **批量验证**：多个签名可以批量验证，速度提升 2-3 倍
- **聚合效率**：签名聚合几乎无额外成本

### 隐私增强

- **多签隐私**：聚合签名使得多签与单签在链上无法区分
- **脚本隐私**：配合 Taproot，复杂脚本可以隐藏为简单支付
- **去关联**：减少了链上分析的可能性

### 可扩展性

- **交易容量**：相同区块空间可容纳更多交易
- **验证效率**：节点验证速度更快
- **网络带宽**：减少数据传输量

## 与其他 BIP 的关系

### BIP341（Taproot）

BIP340 是 Taproot 的基础：
- Taproot 使用 Schnorr 签名作为见证签名
- 密钥路径支出使用 BIP340 签名
- 实现了脚本隐私和效率提升

### BIP342（Tapscript）

Tapscript 中的签名验证使用 BIP340：
- OP_CHECKSIG 和 OP_CHECKSIGVERIFY 支持 Schnorr
- 批量验证优化脚本执行
- 新的操作码利用 Schnorr 特性

### BIP32（HD 钱包）

兼容现有的分层确定性钱包：
- 可以使用相同的密钥派生路径
- BIP86 定义了 Taproot 的标准路径
- 向后兼容，无需改变钱包架构

## 安全注意事项

### 1. 随机数生成

签名过程中的随机数 k 必须：
- 使用密码学安全的随机数生成器
- 每次签名使用不同的 k
- 不能重复使用，否则私钥可被推导

BIP340 推荐使用确定性随机数（RFC 6979）：
- 基于私钥和消息派生 k
- 避免了硬件随机数生成器的风险
- 保证了可重现性和安全性

### 2. 密钥聚合攻击

多方密钥聚合需要防范 rogue key 攻击：
- 使用 MuSig2 等安全协议
- 每个参与方必须证明私钥所有权
- 避免简单的公钥相加

### 3. 侧信道攻击

实现时需要注意：
- 使用常数时间算法
- 防止时间分析攻击
- 保护随机数生成过程

### 4. 消息哈希

BIP340 使用 SHA256 作为标签哈希：
- 防止跨协议攻击
- 使用域分离技术
- 确保签名只在比特币上下文有效

## 实际应用

### Taproot 地址

Taproot 地址（bech32m 格式，以 bc1p 开头）使用 BIP340 签名：
```
bc1p... → Taproot 输出
         └─ 密钥路径支出使用 Schnorr 签名
```

### 多重签名

使用 MuSig2 协议的多签：
- 2-of-2、3-of-3 等多签只需一个签名
- 链上无法区分单签和多签
- 显著节省费用和空间

### 闪电网络

闪电网络使用 Schnorr 签名：
- 减少通道开启和关闭的成本
- 提高隐私性
- 支持更复杂的支付路径

### 原子交换

跨链原子交换可以使用 Schnorr：
- 适配器签名（Adapter Signatures）
- 实现无脚本的条件支付
- 提高效率和隐私

## 兼容性和部署

### 软分叉激活

BIP340 作为 Taproot 升级的一部分于 2021 年 11 月激活：
- 通过 Speedy Trial 激活机制
- 向后兼容，旧节点仍可验证区块
- 新交易类型对旧节点透明

### 钱包支持

主流钱包逐步支持 Taproot/Schnorr：
- **硬件钱包**：Ledger、Trezor、Coldcard
- **软件钱包**：Bitcoin Core、Sparrow、Electrum
- **库和工具**：libsecp256k1、btcd、rust-bitcoin

### 生态采用

- **交易所**：逐步支持 Taproot 充值和提现
- **DeFi 协议**：闪电网络、侧链集成
- **企业应用**：批量支付、托管服务

## 与 ECDSA 的对比

| 特性 | BIP340 Schnorr | ECDSA |
|------|---------------|-------|
| 签名大小 | 64 字节 | 71-72 字节 |
| 公钥大小 | 32 字节 | 33 字节（压缩） |
| 签名聚合 | 支持 | 不支持 |
| 批量验证 | 支持（2-3倍加速） | 不支持 |
| 可证明安全性 | 有 | 无 |
| 多签隐私 | 高（聚合签名） | 低（独立签名） |
| 线性特性 | 有 | 无 |
| 标准化程度 | BIP340 定义 | SEC1 标准 |

## 未来发展

### 跨输入签名聚合

未来可能支持跨输入的签名聚合：
- 一笔交易的所有输入共用一个签名
- 进一步减少交易大小
- 需要额外的协议设计

### 门限签名

基于 Schnorr 的门限签名方案：
- FROST（Flexible Round-Optimized Schnorr Threshold）
- 实现 M-of-N 多签而不暴露阈值
- 提高企业和 DAO 的安全性

### 隐私协议

Schnorr 签名支持更先进的隐私技术：
- 环签名和盲签名
- 隐私保护的支付通道
- 零知识证明集成

## 总结

BIP340 通过引入 Schnorr 签名，为比特币带来了显著的技术升级：

**核心优势**：
- **效率**：更小的签名和公钥，更快的验证速度
- **隐私**：签名聚合使得复杂交易看起来简单
- **可扩展性**：减少区块空间占用，提高网络容量
- **安全性**：可证明安全，更强的理论基础
- **灵活性**：支持先进的多签和智能合约

**实际影响**：
- 降低交易费用
- 提高网络吞吐量
- 增强用户隐私
- 支持更复杂的应用场景

BIP340 与 BIP341（Taproot）、BIP342（Tapscript）共同构成了比特币最重要的升级之一，为比特币的未来发展奠定了坚实基础。这不仅是技术上的进步，更是比特币社区在保持去中心化和安全性的前提下，持续创新和改进协议的体现。
