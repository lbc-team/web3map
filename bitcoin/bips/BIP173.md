# BIP173: Bech32

## 概念简介

BIP173(Bitcoin Improvement Proposal 173)定义了 Bech32 编码格式,这是一种专为 SegWit(隔离见证)地址设计的新型比特币地址格式。Bech32 由 Pieter Wuille 和 Greg Maxwell 于 2017 年提出,旨在替代传统的 Base58Check 编码格式,提供更好的错误检测能力、更低的费用和更友好的用户体验。

Bech32 地址以 "bc1" 开头(主网)或 "tb1" 开头(测试网),使用小写字母和数字,完全避免了容易混淆的字符(如 0、O、I、l)。这种格式不仅提升了地址的可读性,还通过强大的校验和机制,能够检测并定位几乎所有的输入错误。

BIP173 的推出标志着比特币地址格式的重大进步。虽然 Bech32 地址最初主要用于 SegWit 交易,但随着时间推移,其应用范围不断扩大。到 2024 年,Bech32 地址已成为比特币生态系统中最推荐使用的地址格式,被各大钱包和交易所广泛支持。

## 核心特性

**编码字符集**

Bech32 使用 32 个字符的编码字符集:`qpzry9x8gf2tvdw0s3jn54khce6mua7l`,这些字符经过精心挑选,排除了容易混淆的 0、O、I、l 和 1、i 等字符。这种设计大大减少了人工抄写地址时出错的可能性,同时保持了良好的可读性。字符集的选择还考虑了 QR 码的兼容性,使得 Bech32 地址可以高效地编码为二维码。

**强大的校验和**

Bech32 采用 BCH(Bose-Chaudhuri-Hocquenghem)码作为校验和算法,具有以下特性:

- 可以检测任何单字符错误
- 可以检测任意 4 个字符的错误
- 可以定位最多 2 个字符的错误(假设没有其他错误)
- 可以检测最多 89 个字符长度的任何突发错误

相比之下,传统 Base58Check 编码的错误检测率约为 99.96%,而 Bech32 的错误检测能力接近 100%。

**SegWit 原生支持**

Bech32 专门为 SegWit 地址设计,与使用 P2SH 封装的 SegWit 地址(以 3 开头)相比,原生 Bech32 地址的交易数据更小,可以节省约 16% 的网络费用,同时提升交易处理效率。

**版本灵活性**

Bech32 地址支持不同的见证版本(0-16),为未来的协议升级预留了空间。例如 SegWit v0 使用版本 0,而 Taproot(BIP341)使用版本 1。这种设计使得比特币网络可以在不改变地址格式的情况下引入新功能。

**人类可读前缀(HRP)**

Bech32 地址包含人类可读前缀(Human-Readable Part),用于区分不同的网络:
- `bc` - 比特币主网
- `tb` - 比特币测试网
- `bcrt` - 比特币回归测试网

HRP 的存在使得不同网络的地址在视觉上就能区分,降低了误操作的风险。

## 技术优势

**提升交易效率**

Bech32 原生 SegWit 地址相比传统地址在交易体积上更小。对于 P2WPKH(Pay-to-Witness-Public-Key-Hash)类型的交易,使用 Bech32 地址可以显著降低交易费用,同时提高网络的整体吞吐量。长期使用 Bech32 地址还能为用户节省可观的交易成本。

**增强用户体验**

由于 Bech32 完全使用小写字母,在扫描 QR 码或手动输入地址时更加便捷。地址的校验和机制还能在用户输入错误时及时提醒,避免将资金发送到错误或不存在的地址。这种用户友好的设计大大降低了操作失误的风险。

**兼容性良好**

Bech32 地址可以向后兼容不同的见证版本,这意味着未来的比特币协议升级(如引入新的签名算法或隐私功能)可以无缝使用现有的地址格式,而不需要再次更换地址标准。

**降低错误率**

由于强大的错误检测能力,Bech32 地址在传输和复制过程中出现错误的可能性极低。即使发生错误,系统也能快速识别,而不是将资金发送到错误地址导致永久损失。

## 地址格式

**地址结构**

Bech32 地址由三部分组成:

```
[人类可读前缀][分隔符][数据部分][校验和]
```

示例:`bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4`

- `bc` - 人类可读前缀(比特币主网)
- `1` - 分隔符
- `qw508d6qejxtdg4y5r3zarvary0c5xw7k` - 数据部分(见证版本 + 见证程序)
- `v8f3t4` - 6 个字符的校验和

**见证版本**

数据部分的第一个字符编码了见证版本:
- `q` (= 0) - SegWit v0(标准地址)
- `p` (= 1) - Taproot(BIP341)
- 版本 2-16 为未来协议升级预留

**见证程序长度**

- SegWit v0: 20 字节(P2WPKH)或 32 字节(P2WSH)
- SegWit v1(Taproot): 32 字节
- 未来版本: 2-40 字节

## 编码示例

**SegWit v0 P2WPKH 地址**

```
见证版本: 0
见证程序: 751e76e8199196d454941c45d1b3a323f1433bd6
Bech32 地址: bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4
```

**SegWit v1 Taproot 地址**

```
见证版本: 1
见证程序: 5100...(32 字节)
Bech32 地址: bc1p5cyxnuxmeuwuvkwfem96lqzszd02n6xdcjrs20cac6yqjjwudpxqkedrcr
```

## 编码过程

**编码步骤**

1. 确定人类可读前缀(如 "bc")
2. 分隔见证版本和见证程序,转换为 5-bit 组
3. 计算 6 个字符的 BCH 校验和
4. 将所有部分映射为 Bech32 字符集中的字符

**解码步骤**

1. 验证地址格式和字符合法性
2. 分离人类可读前缀和数据部分
3. 验证校验和
4. 提取见证版本和见证程序
5. 验证见证程序的长度合法性

**校验和算法**

Bech32 使用基于多项式 `x^6 + x^5 + x^3 + 1`(常量为 1)计算的 BCH 校验和。校验和的生成过程确保了对所有可能的错误模式(包括 HRP、数据和校验和本身)都能提供强大的错误检测,最终目标是多项式除法余数为 1。

## 发展历程

**2016 年:概念萌芽**

Pieter Wuille 和 Greg Maxwell 开始为比特币地址研究更好的编码方案,目标是设计一种具有强大错误检测能力的新格式。

**2017 年 3 月:BIP173 提案**

正式提交提案,定义了 Bech32 编码规范和 SegWit 地址格式。提案详细阐述了编码的数学原理、校验和生成方法和实现细节。

**2017 年 8 月:SegWit 激活**

随着 SegWit 在比特币主网激活,Bech32 地址开始可以用于 SegWit 地址格式。

**2018-2019 年:生态采用**

主流钱包(Bitcoin Core、Electrum、Ledger、Trezor 等)和交易所开始支持 Bech32 地址。用户采用率逐步提升,交易费用节省效果显现。

**2020 年:发现潜在缺陷**

研究者发现 Bech32 在某些边缘情况下存在长度扩展缺陷,导致 BIP350(Bech32m)的提出,用于修复这一问题。

**2021 年:Taproot 与 Bech32m**

Taproot 升级采用 Bech32m 编码(BIP350),而不是原始 Bech32,以解决长度扩展问题。SegWit v0 地址继续使用原始 Bech32。

**2022-2024 年:主流化**

Bech32 地址成为比特币生态系统的标准,被广泛推荐给普通用户使用。大多数服务和钱包都已完全支持 Bech32。

## 应用实例

**钱包支持**

主流比特币钱包(如 Bitcoin Core、Electrum、BlueWallet)都原生支持 Bech32 地址,允许用户轻松创建和接收效率更高的交易。

**交易所集成**

主流交易所(Coinbase、Kraken、Binance 等)已支持用户向 Bech32 地址提现,并鼓励用户使用 Bech32 地址以降低网络费用。

**支付处理**

支付处理商使用 Bech32 地址批量处理付款,
充分利用地址格式带来的费用优势和 SegWit 的交易容量提升。

**硬件钱包**

Ledger、Trezor、Coldcard 等硬件钱包完全支持 Bech32 地址,确保离线签名和安全存储比特币资产。

**区块浏览器**

主流比特币区块浏览器均支持 Bech32 地址查询,并显示相关交易信息。

## 常见问题

**兼容性问题**

虽然所有支持 SegWit 的服务都应该能够向 Bech32 地址发送资金,但在早期阶段,部分老旧钱包和服务可能不支持。

**大小写敏感**

Bech32 地址不区分大小写,但推荐使用小写字母。部分钱包可能仅支持 P2SH 封装的 SegWit 地址(以 3 开头),无法识别原生 Bech32 格式。

**版本升级问题**

钱包必须能够识别不同的见证版本(如 Taproot)。使用 Bech32 地址时应确认钱包是否支持目标见证版本,否则可能无法正确识别或使用这些地址。

## 注意事项

**不可逆性**

发送到错误地址的比特币无法撤回。虽然 Bech32 的校验和能检测大多数错误,但用户仍应仔细核对地址后再发送交易。

**地址验证**

在接受 Bech32 地址付款前,务必验证地址的有效性。可以使用在线工具或编程库验证地址格式和校验和。

**软件更新**

确保使用最新版本的钱包软件,以获得最佳的 Bech32 支持和安全性。

**备份地址**

与其他地址类型一样,应妥善备份 Bech32 地址对应的私钥或助记词,以防数据丢失。

**混合使用**

可以同时使用 Bech32 地址和传统地址,根据接收方的支持情况灵活选择。

## 相关 BIP

**BIP141**: 定义了隔离见证(SegWit)的核心提案,Bech32 是其配套的地址格式。

**BIP143**: 定义了 SegWit 的签名验证算法改进。

**BIP350**: 定义了 Bech32m 编码,修复了 Bech32 的长度扩展缺陷,用于 SegWit v1+。

**BIP341**: 定义了 Taproot,使用 Bech32m 编码(见证版本 1)。

## 工具和资源

**在线工具**

- [Bech32 地址生成器](https://slowli.github.io/bech32-buffer/)
- [Bech32 编码演示器](https://bitcoin.sipa.be/bech32/demo/demo.html)

**开发库**

- [参考实现(C++)](https://github.com/sipa/bech32)
- [JavaScript 实现](https://github.com/bitcoinjs/bech32)
- [Python 实现](https://github.com/fiatjaf/bech32)

**文档**

- [BIP173 规范](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki)
- [Bitcoin Core 文档](https://bitcoincore.org/en/segwit_wallet_dev/)

## 参考资料

- [BIP173 完整规范](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki)
- [Pieter Wuille 的 Bech32 参考实现](https://github.com/sipa/bech32/tree/master/ref/c)
- [SegWit 地址格式](https://bitcoincore.org/en/segwit_wallet_dev/)
- [BIP350: Bech32m](https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki)
- [比特币地址格式对比](https://en.bitcoin.it/wiki/Address)
