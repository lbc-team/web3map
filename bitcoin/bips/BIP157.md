# BIP157

## 概念简介

BIP157（Bitcoin Improvement Proposal 157）是比特币轻客户端协议的改进提案，定义了基于确定性区块内容过滤器的轻客户端协议。该协议与 BIP158 配合使用，BIP158 定义了紧凑区块过滤器（Compact Block Filters）的数据结构。

BIP157/158 旨在为轻量级[比特币](https://learnblockchain.cn/tags/比特币?map=BTC)客户端提供一种既保护隐私又节省带宽的区块链同步方式，是 BIP37 布隆过滤器的改进替代方案。

## 工作原理

**过滤器生成（BIP158）**
全节点使用 BIP158 为每个区块创建 Golomb-Rice 编码集（GCS），这些集合称为"过滤器"，包含区块中的所有相关数据（如地址、交易输出等）。

**过滤器分发（BIP157）**
1. 轻客户端从全节点下载紧凑的区块过滤器
2. 客户端在本地检查过滤器，查看是否有与自己相关的交易
3. 如果发现匹配，客户端下载完整区块以获取相关交易
4. 如果没有匹配，跳过该区块，无需下载

## 相比其他方案的优势

**相比 BIP37 布隆过滤器**
- **更好的隐私**：客户端不向节点透露自己的地址
- **更安全**：减少了对诚实节点的攻击风险
- **服务器友好**：全节点计算负担更轻

**相比地址索引服务器（如 Electrum）**
- **更好的隐私**：不需要向服务器查询特定地址
- **更低的服务器要求**：需要更少的存储和 CPU
- **更去中心化**：不依赖特定的索引服务器

**权衡**
- BIP157/158 在正常情况下消耗的带宽比上述两种协议都要多
- 需要下载所有区块的过滤器（虽然很小）

## Bitcoin Core 支持

- Bitcoin Core 从 v0.21.0 开始支持提供 BIP157 类型的过滤器
- 节点可以通过 P2P 网络为其他节点提供符合 BIP157 的区块过滤器
- 钱包可以使用 BIP157 进行快速重新扫描

## 应用场景

1. **移动钱包**：在手机上运行的轻量级[比特币](https://learnblockchain.cn/tags/比特币?map=BTC)[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)
2. **快速同步**：新[钱包](https://learnblockchain.cn/tags/%E9%92%B1%E5%8C%85)快速同步历史交易
3. **隐私保护**：不向第三方透露自己的地址
4. **去中心化**：直接连接到 P2P 网络，不依赖中心化服务

## 推荐阅读

- [Compact Block Filters](https://bitcoinops.org/en/topics/compact-block-filters/)
- [BIP 158 Specification](https://github.com/bitcoin/bips/blob/master/bip-0158.mediawiki)
- [Bitcoin Core PR Review](https://bitcoincore.reviews/16442)

## 相关概念

- **BIP37 布隆过滤器**
- **BIP158 紧凑区块过滤器**
- **轻客户端 (SPV)**
- **Golomb-Rice 编码**
- **P2P 网络**
