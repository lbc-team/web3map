# BIP113 - 中位时间过去值作为锁定时间端点

BIP113（Bitcoin Improvement Proposal 113）是比特币改进提案之一，由 Thomas Kerin 和 Mark Friedenbach 在 2015 年提出。该提案修改了比特币交易的时间锁定验证逻辑，使用过去 11 个区块的中位时间（Median Time-Past, MTP）来替代单个区块的时间戳，从而提高了时间锁定交易的可靠性和安全性。

## 核心概念

在 BIP113 之前，比特币使用区块头中的时间戳来验证 nLockTime 和 OP_CHECKLOCKTIMEVERIFY（BIP65）的时间锁定条件。然而，区块时间戳可能被矿工在一定范围内操纵，这给依赖精确时间锁定的智能合约带来了不确定性。

BIP113 引入了中位时间过去值（MTP）的概念，即取过去 11 个区块时间戳的中位数作为当前区块的"时间"。这种机制显著减少了单个矿工操纵时间的能力，提高了时间锁定的可预测性。

## 问题背景

### 区块时间戳的问题

在 BIP113 之前存在以下问题：

1. **矿工操纵**：
   - 矿工可以在一定范围内设置区块时间戳
   - 只要满足：时间戳 > 过去 11 个区块的中位时间
   - 且时间戳 < 网络调整时间 + 2 小时
   - 矿工有约 2 小时的操纵空间

2. **时间锁定不确定性**：
   - 依赖 nLockTime 的交易可能提前或延迟确认
   - OP_CHECKLOCKTIMEVERIFY 脚本的执行时间不可预测
   - 给闪电网络、HTLC 等时间敏感应用带来风险

3. **攻击向量**：
   - 恶意矿工可能故意延后区块时间戳
   - 阻止时间锁定交易的确认
   - 或提前解锁本应锁定的资金

### 实际案例

考虑一个场景：
```
Alice 创建了一笔交易，nLockTime = 区块高度 500,000
当区块 499,999 被挖出时，Alice 期望在下一个区块确认
但如果矿工将区块 500,000 的时间戳设置得很晚
Alice 的交易可能被延迟数小时才能确认
```

## 中位时间过去值（MTP）

### 定义

中位时间过去值是过去 11 个区块时间戳的中位数：

```
MTP(block N) = Median(timestamps of blocks N-10 到 N)
```

### 计算示例

假设当前区块为 500,000，过去 11 个区块的时间戳为：

```
区块 499,990: 1609459200
区块 499,991: 1609459800
区块 499,992: 1609460400
区块 499,993: 1609461000
区块 499,994: 1609461600
区块 499,995: 1609462200  ←
区块 499,996: 1609462800  ← 第 6 个（中位数）
区块 499,997: 1609463400  ←
区块 499,998: 1609464000
区块 499,999: 1609464600
区块 500,000: 1609465200

MTP(500,000) = 1609462800  （第 6 个时间戳）
```

## 主要变更

### 1. nLockTime 验证

**旧规则**（BIP113 之前）：
```
if (nLockTime < block.time) {
    // 交易可以被包含在区块中
}
```

**新规则**（BIP113 之后）：
```
if (nLockTime < MTP) {
    // 交易可以被包含在区块中
}
```

### 2. OP_CHECKLOCKTIMEVERIFY

**旧规则**：
```
if (nLockTime < block.time) {
    return true;
}
```

**新规则**：
```
if (nLockTime < MTP) {
    return true;
}
```

### 3. nSequence / OP_CHECKSEQUENCEVERIFY

BIP113 也影响了后续引入的 BIP68 和 BIP112：
- BIP68（相对时间锁定）使用 MTP
- BIP112（OP_CHECKSEQUENCEVERIFY）使用 MTP

## 技术优势

### 1. 减少时间操纵

单个矿工无法显著影响 MTP：
- 需要控制连续多个区块才能操纵 MTP
- 即使控制 1 个区块，MTP 最多偏移约 10 分钟（1/11）
- 控制 6 个区块才能完全控制 MTP，成本极高

### 2. 提高可预测性

交易创建者可以更准确预测解锁时间：
- MTP 变化平滑，不会突然跳跃
- 大约每 10 分钟（一个区块）增加 10 分钟
- 时间锁定的触发时间更可靠

### 3. 增强安全性

对于时间敏感的智能合约：
- HTLC（哈希时间锁定合约）更安全
- 闪电网络的超时机制更可靠
- 原子交换的时间窗口更精确

### 4. 向后兼容

BIP113 是软分叉：
- 旧节点仍可验证新区块
- 新规则比旧规则更严格
- 不会导致链分裂

## 实际应用

### 闪电网络

闪电网络使用时间锁定来保护通道安全：

```
通道双方同意：
- 合作关闭：无时间锁定
- 单方关闭：锁定 144 个区块（约 1 天）
- 欺诈惩罚：在锁定期内检测并惩罚

BIP113 确保时间锁定可靠：
- 恶意方无法通过操纵时间戳提前取款
- 诚实方有足够时间响应欺诈行为
```

### HTLC（哈希时间锁定合约）

跨链原子交换依赖 HTLC：

```
Alice (比特币) ↔ Bob (莱特币)

步骤 1：Alice 创建 HTLC，锁定时间 = MTP + 24 小时
步骤 2：Bob 创建 HTLC，锁定时间 = MTP + 12 小时
步骤 3：Alice 揭示密钥，Bob 取得比特币
步骤 4：Bob 使用同一密钥取得莱特币

如果中途失败：
- 12 小时后 Bob 可以退款
- 24 小时后 Alice 可以退款
- 时间差确保没有资金损失
```

BIP113 确保上述时间窗口可靠，防止一方通过操纵时间戳作弊。

### 托管服务

多重签名托管钱包：

```
2-of-3 多签钱包：
- 买方
- 卖方
- 托管方

场景：
1. 买方支付到多签地址
2. 如果交易顺利，买方+卖方签名释放资金给卖方
3. 如果有争议，托管方介入
4. 30 天后，如果无人行动，买方可单方面退款（nLockTime）

BIP113 确保 30 天期限准确，托管方有充足时间处理
```

### 继承规划

时间锁定的继承安排：

```
遗产地址：
- 正常情况：持有人使用主私钥花费
- 紧急情况：1 年后继承人可使用备用私钥

实现：
- 主路径：持有人签名，无时间限制
- 备用路径：继承人签名 + OP_CHECKLOCKTIMEVERIFY(1 年)

BIP113 保证继承人不能通过操纵时间提前继承
```

## 与其他 BIP 的关系

### BIP65（OP_CHECKLOCKTIMEVERIFY）

BIP113 修改了 BIP65 的时间验证逻辑：
- BIP65 引入了 OP_CHECKLOCKTIMEVERIFY 操作码
- BIP113 改变了该操作码的时间比较基准
- 从 block.time 改为 MTP

### BIP68（相对时间锁定）

BIP68 引入了相对时间锁定（nSequence）：
- 使用 MTP 作为时间基准
- 允许"在 N 个区块/小时之后"类型的锁定
- BIP113 确保相对时间锁定的可靠性

### BIP112（OP_CHECKSEQUENCEVERIFY）

BIP112 引入了检查相对时间锁定的操作码：
- 验证逻辑使用 MTP
- 配合 BIP68 和 BIP113 实现可靠的相对锁定

### BIP9（版本位）

BIP113 通过 BIP9 的版本位机制激活：
- 使用版本位 bit 0
- 与 BIP68、BIP112 同时激活
- 统称为"CSV（CheckSequenceVerify）软分叉"

## 激活与部署

### 软分叉激活

BIP113 于 2016 年 7 月激活：
- 激活方式：BIP9 版本位 bit 0
- 激活高度：419,328（2016 年 7 月 4 日）
- 与 BIP68、BIP112 一起激活
- 矿工支持率达到 95% 后锁定

### 兼容性

**向后兼容**：
- 旧节点可以验证新区块
- 新规则是旧规则的子集
- 不会导致链分裂

**向前兼容**：
- 新节点拒绝违反 BIP113 的区块
- 旧节点可能接受这些区块（但极少发生）

## 安全注意事项

### 1. 时间精度

MTP 提供的时间精度：
- 约 10 分钟（一个区块时间）
- 不适合需要秒级精度的应用
- 对于大多数时间锁定应用已足够

### 2. 时钟同步

节点的本地时钟仍然重要：
- 用于验证新区块的时间戳
- 时钟偏差超过 2 小时可能导致问题
- 建议使用 NTP 保持时钟同步

### 3. 长期时间锁定

对于长期锁定（如年份级别）：
- MTP 提供了良好的保护
- 但仍需考虑硬件故障、密钥管理等风险
- 建议结合多重签名和备份方案

### 4. 跨链应用

跨链原子交换需要注意：
- 不同链的 MTP 计算可能略有差异
- 时间窗口应留有充足余量
- 建议至少 6-12 个区块的缓冲

## 技术细节

### MTP 计算算法

```python
def calculate_mtp(block_height):
    """计算指定区块高度的 MTP"""
    if block_height < 11:
        # 前 11 个区块使用特殊规则
        return 0

    # 收集过去 11 个区块的时间戳
    timestamps = []
    for i in range(11):
        block = get_block(block_height - i)
        timestamps.append(block.timestamp)

    # 返回中位数
    timestamps.sort()
    return timestamps[5]  # 第 6 个元素（索引 5）
```

### nLockTime 验证

```python
def verify_locktime(tx, block):
    """验证交易的 nLockTime"""
    if tx.nLockTime == 0:
        return True  # 无锁定

    # 计算当前区块的 MTP
    mtp = calculate_mtp(block.height)

    # 区分区块高度锁定和时间戳锁定
    if tx.nLockTime < 500000000:
        # 区块高度锁定
        return tx.nLockTime < block.height
    else:
        # 时间戳锁定（使用 MTP）
        return tx.nLockTime < mtp
```

### OP_CHECKLOCKTIMEVERIFY 实现

```python
def op_checklocktimeverify(stack, tx, mtp):
    """执行 OP_CHECKLOCKTIMEVERIFY"""
    if len(stack) < 1:
        return False

    locktime = stack[-1]  # 栈顶元素

    # 验证锁定时间
    if locktime < 0:
        return False

    # 区分区块高度和时间戳
    if locktime < 500000000:
        # 区块高度
        threshold = tx.block_height
    else:
        # 时间戳（使用 MTP）
        threshold = mtp

    # 检查是否已解锁
    if locktime >= threshold:
        return False  # 尚未解锁

    return True
```

## 对比：BIP113 前后

| 特性 | BIP113 之前 | BIP113 之后 |
|------|------------|------------|
| 时间基准 | 区块时间戳 | 中位时间过去值（MTP） |
| 矿工操纵能力 | 高（约 2 小时） | 低（需控制多个区块） |
| 时间可预测性 | 较低 | 高 |
| 时间锁定可靠性 | 不稳定 | 稳定 |
| 闪电网络安全性 | 存在风险 | 显著提升 |
| 激活方式 | N/A | 软分叉（BIP9） |
| 向后兼容性 | N/A | 是 |

## 实际影响

### 对用户的影响

- **更可靠的时间锁定**：继承、托管等应用更安全
- **更好的隐私保护**：时间锁定交易不易被识别
- **降低风险**：减少因时间操纵导致的资金损失

### 对开发者的影响

- **更简单的智能合约**：时间逻辑更可预测
- **更安全的协议**：HTLC、闪电网络等更可靠
- **更好的用户体验**：减少因时间不确定性导致的问题

### 对矿工的影响

- **限制时间操纵**：无法通过单个区块显著影响 MTP
- **规范区块时间戳**：需要更准确的时间戳设置
- **保持兼容性**：遵循 MTP 规则以避免区块被拒绝


### Layer2 应用

BIP113 为 Layer2 提供了基础：
- 闪电网络的通道超时机制
- 侧链的跨链交易
- 状态通道的争议解决

### 智能合约

更复杂的时间相关智能合约：
- 定期支付（工资、租金）
- 时间衰减的投票权
- 基于时间的条件执行

## 总结

BIP113 通过引入中位时间过去值（MTP），显著提升了比特币时间锁定机制的可靠性和安全性：

**核心改进**：
- **可靠性**：减少矿工操纵时间的能力
- **可预测性**：时间锁定的触发时间更精确
- **安全性**：保护时间敏感的智能合约
- **兼容性**：软分叉实现，向后兼容

**实际价值**：
- 为闪电网络等 Layer2 方案奠定基础
- 使 HTLC 和原子交换更加安全
- 支持继承、托管等实际应用
- 提升用户对时间锁定的信任

BIP113 是比特币协议演进中的重要一步，它解决了一个长期存在的安全隐患，为更复杂的智能合约和 Layer2 应用铺平了道路。虽然这是一个相对简单的改动，但其影响深远，是构建可靠的去中心化金融系统不可或缺的基础设施。
